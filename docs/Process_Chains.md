# مستندات زنجیره عملیاتی سیستم تحلیل (TSE Analysis Process Chains)

این سند معماری و چهار لایه اصلی عملیاتی سیستم را تشریح می‌کند که برای اطمینان از پایداری داده‌ها و دقت تحلیل‌ها طراحی شده است.

---

## ۱. لایه تامین داده و عبور از محدودیت‌ها (Data Sourcing & Anti-Block)
این لایه وظیفه دریافت، پالایش و تضمین پایداری جریان داده‌ها را بر عهده دارد.

- **کلاینت هوشمند (TSETMCClient):** پیاده‌سازی `requests.Session` با مکانیزم چرخش هدر (Fingerprinting) برای شبیه‌سازی دقیق رفتار مرورگر نسخه ۱۱۵+ به بالا.
- **سیستم Fallback هوشمند (Native Curl):** در صورت بروز خطای اتصال (مانند `ConnectionResetError 10054`) یا اختلال در SSL Handshake، سیستم به صورت خودکار با استفاده از سوئیچ‌های `-k` (بای‌پس SSL) و `--compressed` از زیرساخت سیستم‌عامل برای دور زدن فایروال‌های سخت‌افزاری (IPS/WAF) استفاده می‌کند.
- **طبقه‌بندی ساختاری نمادها:** استفاده از منطق ترکیبی `cs_id` و کدینگ بازار (Market Flow) برای تفکیک بلادرنگ داده‌های واقعی به دسته‌های:
    - **سهام (Equity):** بازارهای بورس و فرابورس (`flow` ۱ تا ۴).
    - **بازار پایه (Base):** شناسایی خودکار تابلوهای زرد، نارنجی و قرمز (`flow` ۵ تا ۸).
    - **صندوق‌ها (ETF):** فیلترینگ بر اساس `cs_id: 68`.
    - **اوراق درآمد ثابت:** تفکیک اوراق سلف، صکوک و اخزا (`cs_id: 69`).
    - **تسهیلات مسکن:** مدیریت جداگانه نمادهای تسه و تملی (`cs_id: 59`).

---

## ۲. لایه موتور محاسباتی (Analytical Engine)
در این بخش، داده‌های خام با استفاده از کتابخانه‌هایی نظیر `pandas` و `ta` پردازش شده و به متغیرهای تحلیل‌پذیر تبدیل می‌شوند.

- **یکپارچگی و بازآرایی تایم‌فریم‌ها:** پیاده‌سازی متد `resample_to_weekly` برای تبدیل خودکار داده‌های روزانه به هفتگی با حفظ دقت در قیمت‌های باز/بسته، سقف/کف و حجم معاملات (Resampling Logic).
- **محاسبه هوشمند اندیکاتورها:** استخراج طیف وسیعی از شاخص‌ها شامل:
    - **روند:** SMA-20/50، EMA، MACD و ADX.
    - **نوسان‌نما (Oscillators):** RSI-14 و Stochastic.
    - **پویایی بازار:** باندهای بولینگر (Volatility) و ترازهای Ichimoku (Cloud, Base, Conversion).
- **هوش الگوشناسی:** تشخیص خودکار الگوهای شمعی کلاسیک مانند **Doji** و **Hammer** بر اساس تناسب بدنه و سایه‌ها.
- **پاکسازی و استانداردسازی (OHLCV Mapping):** تبدیل داده‌های خام وب‌سرویس (`pc`, `tvol` و ...) به فیلد‌های استاندارد و اعمال رند کردن هوشمند (Smart Rounding) اعداد بر اساس قیمت سهم جهت خوانایی گزارش‌ها.

---

## ۳. لایه هوش استراتژیک (Intelligence Layer)
این لایه به عنوان مغز متفکر سیستم، داده‌های محاسباتی را به استراتژی‌های قابل معامله تبدیل می‌کند.

- **تحلیل هوشمند سطوح کلیدی (Advanced S/R):** شناسایی سطوح حمایت و مقاومت با استفاده از الگوریتم خوشه‌بندی (Clustering) با تلرانس ۲٪. قدرت هر سطح بر اساس تعداد دفعات برخورد (Hits) و نزدیکی به قیمت جاری به صورت داینامیک محاسبه می‌شود.
- **ترازهای فیبوناچی بازگشتی (Fibonacci):** ترسیم ترازهای اصلاحی (۲۳.۶٪ تا ۶۱.۸٪) بر اساس سقف و کف بازه ۱۲۰ روزه (تقریباً ۶ ماه اخیر) جهت پیش‌بینی نقاط برگشت روند.
- **استراتژی ریسک به ریواک (R/R Strategy):** محاسبه خودکار نقطه ورود، حد ضرر (۲٪ پایین‌تر از حمایت) و حد سود (محدوده مقاومت) به همراه رتبه‌بندی جذابیت معامله در سه سطح **Attractive**، **Fair** و **Risky**.
- **رصد واگرایی‌ها (Divergence Detection):** تحلیل همزمان رفتار قیمت و اندیکاتور RSI در یک پنجره ۵۰ کندلی برای شناسایی واگرایی‌های مثبت و منفی که نشان‌دهنده ضعف در روند فعلی هستند.
- **بهینه‌سازی سیگنال بر اساس Win-Rate:** رتبه‌بندی اندیکاتورها (RSI, MACD, SMA, ...) برای هر نماد به صورت اختصاصی. این لایه با بررسی بازدهی تاریخی ۵ روز آینده (Future Return) پس از هر سیگنال، دقیق‌ترین اندیکاتور را برای آن سهم خاص پیشنهاد می‌دهد.

---

## ۴. لایه مانیتورینگ و تجربه کاربری (Monitoring & UX)
این لایه وظیفه ارائه تحلیل‌ها در قالب یک رابط کاربری مدرن، تعاملی و در دسترس را بر عهده دارد.

- **ذخیره‌سازی امن و مقاوم (Safe Storage):** استفاده از لایه‌های انتزاعی `getStorageItem` و `setStorageItem` برای مدیریت تنظیمات کاربر (مانند تم، دیده‌بان و هشدارها). این متدها مجهز به بلاک‌های `try/catch` هستند تا در صورت مسدود بودن Storage توسط مرورگر (Privacy Mode)، از متوقف شدن اجرای برنامه جلوگیری کنند.
- **طراحی مدرن Glassmorphism:** استفاده از استایل‌های شیشه‌ای (Backdrop Filter) و گروه‌بندی منطقی ابزارها در سایدبار شامل:
    - **مدیریت بازار و نماد:** انتخاب سریع بازارها و جستجوی بلادرنگ با نرمال‌سازی متون فارسی.
    - **دیده‌بان شخصی (Watchlist):** امکان پین کردن نمادهای مورد علاقه برای دسترسی سریع.
    - **داشبورد وضعیت وب‌سرویس:** نمایش زنده آمار درخواست‌های موفق و مسدود شده به تفکیک هر سرویس (Symbols, Technical, Codal و ...).
- **سیستم پایش قیمت (Price Alerts):** امکان ثبت هشدارهای قیمتی (بالاتر/پایین‌تر) با پشتیبانی از **Web Notifications** مرورگر جهت اطلاع‌رسانی بلادرنگ.
- **خروجی‌های چندرسانه‌ای و AI-Ready:** مجهز به ابزارهای خروجی متنوع شامل:
    - دانلود نمودارهای تکنیکال با کیفیت بالا.
    - تولید فایل‌های Excel و CSV با فرمت‌بندی استاندارد.
    - **بسته جامع AI:** تولید خودکار گزارش‌های Markdown و فایل‌های JSON بهینه‌سازی شده برای تحلیل توسط هوش مصنوعی (ChatGPT/Claude).

---

*آخرین آپدیت: ژانویه ۲۰۲۶*
