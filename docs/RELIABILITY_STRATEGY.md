# مستند استراتژی تاب‌آوری و مدیریت ترافیک هوشمند (Resilience Strategy)

این مستند تشریح‌کننده معماری امنیتی و استراتژی‌های پیاده‌سازی شده در پروژه برای تضمین دسترسی پایدار به داده‌های بورس تهران (TSETMC) و عبور از محدودیت‌های حفاظتی (NGFW) است.

---

## ۱. لایه انگشت‌نگاری دیجیتال (JA3/TLS Fingerprinting)

فایروال‌های پیشرفته نسل جدید (NGFW)، ترافیک ربات‌ها را نه از روی نام مرورگر (User-Agent)، بلکه از روی نحوه دست‌دست کردن پروتکل TLS شناسایی می‌کنند.

*   **چالش:** کتابخانه‌های استاندارد پایتون (Requests) امضای دیجیتال تکراری و تابلویی دارند.
*   **راهکار:** استفاده از **تکنولوژی TLS-Client** که با پیاده‌سازی پشته شبکه مرورگرهای واقعی (Chrome, Firefox)، امضای JA3 کاملاً انسانی تولید می‌کند.
*   **پیاده‌سازی:** در فایل `app.py` از شناسه‌های رندوم مرورگر استفاده می‌شود تا در هر بار اجرا، هویت متفاوتی برای سرور بورس ارسال شود.

---

## ۲. استراتژی مدارشکن (Circuit Breaker)

این لایه نقش **فیوز محافظتی** از IP سرور شما را ایفا می‌کند.

*   **نحوه عملکرد:** سیستم تعداد خطاهای متوالی شبکه (مانند Reset شدن اتصال توسط فایروال بورس) را مانیتور می‌کند. 
*   **قفل خودکار:** اگر سیستم تشخیص دهد که ترافیک مشکوک شناسایی شده، به مدت ۱۰ دقیقه هیچ درخواستی به شبکه ارسال نمی‌کند.
*   **مزیت:** جلوگیری از قرار گرفتن IP شما در لیست سیاه (Blacklist) دائمی وب‌سرویس‌ها.

---

## ۳. لایه انسانی‌سازی رفتار (Jittering & Timing)

ارسال درخواست در فواصل زمانی دقیق (مثلاً دقیقاً هر ۱ ثانیه) نشان‌دهنده رباتیک بودن ترافیک است.

*   **تکنیک:** افزودن **تأخیر متغیر (Jitter)**. بین هر درخواست، سیستم به طور رندوم بین ۰.۵ تا ۱.۵ ثانیه "فکر" می‌کند.
*   **توالی قفل‌شده:** تمام درخواست‌ها به صورت سریالی و با صف‌بندی (Locking Mechanism) ارسال می‌شوند تا از ارسال همزمان درخواست‌های سنگین جلوگیری شود.

---

## ۴. کارگر پس‌زمینه نامحسوس (Stealth Background Worker)

به جای اینکه کاربر را برای دریافت لیست چند هزار نماد معطل کنیم، سیستم به صورت هوشمند عمل می‌کند:

1.  **Pre-warm:** در زمان اجرا، یک فرآیند مخفی در پس‌زمینه شروع به دریافت نمادها می‌کند.
2.  **Registry:** داده‌ها در دیتابیس محلی (SQLite) ذخیره می‌شوند.
3.  **Offline-first:** وقتی شما بازار را تغییر می‌دهید، داده‌ها از دیتابیس خوانده می‌شوند، بدون اینکه درخواستی به اینترنت ارسال شود.

---

## ۵. سلسله‌مراتب کش (Multi-tier Caching)

برای رسیدن به سرعت پاسخ‌دهی زیر ۱۰۰ میلی‌ثانیه، از سه سطح کش استفاده شده است:

| سطح کش | محل ذخیره | مدت زمان ماندگاری | هدف |
| :--- | :--- | :--- | :--- |
| **سطح ۱** | مرورگر (JS Cache) | تا پایان نشست (Session) | سوییچ آنی بین تب‌ها و بازارها |
| **سطح ۲** | حافظه رم سرور (Flask) | ۶ ساعت | کاهش بار روی وب‌سرویس اصلی |
| **سطح ۳** | دیتابیس (SQLite Registry) | دائمی / تا زمان رفرش | کارکرد در زمان قطعی کامل اینترنت |

---

## ۶. تفکیک هوشمند بازارها (Advanced Classification)

به دلیل درهم‌تنیدگی داده‌ها در وب‌سرویس‌های بورس، یک موتور شناسایی در فایل `app.py` پیاده‌سازی شده که بر اساس فیلترهای زیر، جابجایی نمادها را غیرممکن می‌کند:

*   **بورس کالا و انرژی:** بر اساس اسلات‌های نام (سکه، طلا، آتی) و کدهای ISIN در دسته جداگانه قرار می‌گیرند.
*   **فرابورس:** شناسایی از طریق `Flow ID`های اختصاصی (۳ و ۴).
*   **بازار پایه:** جداسازی بر اساس کلمات کلیدی (زرد، نارنجی، قرمز) و پیشوند ISIN مخصوص بازار پایه.

---

## ۷. راهنمای نگهداری (Maintenance)

برای بهترین عملکرد:
*   هر روز صبح یک بار از گزینه **"بروزرسانی کل حافظه"** استفاده کنید.
*   در صورت مشاهده تعداد بالای **"مسدود شده"** در پنل آمار، ۱۰ دقیقه به سیستم استراحت دهید (مدارشکن خودکار عمل خواهد کرد).
*   برای تحلیل تکنیکال، همیشه داده‌ها را به صورت **تعدیل شده (Adjusted)** دریافت کنید تا دیتابیس محلی شما با قیمت‌های شکسته آلوده نشود.

---
**تدوین شده توسط:**GitHub Copilot
**تاریخ:** ۲۰۲۶/۰۱/۰۷
