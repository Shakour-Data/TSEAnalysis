<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه تحلیل پیشرفته TSETMC</title>
    <link rel="icon" href="data:,">
    <!-- Fonts & Icons -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    
    <style>
        :root {
            --primary-color: #1e3a8a; /* Navy Blue */
            --primary-dark: #1e293b;
            --secondary-color: #475569;
            --accent-color: #3b82f6; /* Bright Blue */
            --success-color: #10b981;
            --danger-color: #ef4444;
            --bg-light: #f8fafc;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: #ffffff;
            --card-bg: #ffffff;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --navbar-bg: #1e3a8a;
        }

        [data-theme="dark"] {
            --bg-light: #030712;
            --sidebar-bg: #111827;
            --sidebar-text: #f1f5f9;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --card-shadow: none;
            --navbar-bg: #111827;
        }

        body { 
            background-color: var(--bg-light); 
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            letter-spacing: -0.01em;
        }

        /* Helper Classes */
        .bg-primary-soft { background-color: rgba(30, 58, 138, 0.08) !important; }
        .bg-success-soft { background-color: rgba(16, 185, 129, 0.08) !important; }
        .bg-danger-soft { background-color: rgba(239, 68, 68, 0.08) !important; }
        .bg-info-soft { background-color: rgba(59, 130, 246, 0.08) !important; }
        .bg-warning-soft { background-color: rgba(245, 158, 11, 0.08) !important; }
        .bg-light-soft { background-color: #fcfdfe !important; }
        
        .fw-black { font-weight: 900 !important; }
        .fw-extrabold { font-weight: 800 !important; }
        
        .transition-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .shadow-hover:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important; 
        }

        /* Nav Pills Styling */
        .nav-pills .nav-link {
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid transparent;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.2);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: var(--bg-light);
            border-color: var(--border-color);
        }

        .btn-package {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white !important;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 800;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.2);
        }
        .btn-package:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(30, 58, 138, 0.3);
        }

        /* Sidebar Styling */
        .sidebar { 
            background: var(--sidebar-bg); 
            min-height: 100vh; 
            padding: 0;
            border-left: 1px solid var(--border-color); 
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--sidebar-text);
        }
        
        .sidebar-header {
            padding: 2.5rem 1.5rem;
            background: transparent;
            color: white;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h4 { font-weight: 800; margin: 0; font-size: 1.4rem; letter-spacing: -0.03em; }
        
        #theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #theme-toggle:hover { background: rgba(255,255,255,0.2); transform: rotate(15deg); }

        .sidebar-content { padding: 0 1.25rem 2.5rem 1.25rem; }

        .nav-link { 
            color: rgba(255, 255, 255, 0.7); 
            padding: 0.85rem 1.25rem; 
            border-radius: 14px; 
            margin-bottom: 6px; 
            cursor: pointer; 
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 14px;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .nav-link i { width: 22px; text-align: center; font-size: 1.2rem; transition: transform 0.2s; }
        .nav-link:hover { 
            background-color: rgba(255,255,255,0.08); 
            color: #ffffff; 
            transform: scale(1.02);
        }
        .nav-link:hover i { transform: scale(1.1); }
        .nav-link.active { 
            background-color: #ffffff !important; 
            color: var(--primary-color) !important; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            font-weight: 700;
        }
        .nav-link.disabled { opacity: 0.3; cursor: not-allowed; }

        .section-title { 
            font-size: 0.7rem; 
            font-weight: 800; 
            color: rgba(255, 255, 255, 0.5); 
            margin: 2rem 1.25rem 0.75rem 1.25rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
        }

        /* Main Content */
        .main-content { padding: 2.5rem; }
        
        .card { 
            border-radius: 24px; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            background: var(--card-bg);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        .card:hover { box-shadow: var(--card-shadow-hover); }
        
        .filter-card { border: none; background: var(--card-bg); margin-bottom: 2.5rem; padding: 2rem !important; }

        .form-label { font-weight: 700; color: var(--text-primary); margin-bottom: 0.6rem; font-size: 0.85rem; }
        .form-control, .form-select {
            background-color: var(--bg-light);
            color: var(--text-primary);
            border-radius: 14px;
            border: 2px solid transparent;
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.1);
        }

        /* Navbar Improvement */
        .navbar { 
            background-color: var(--navbar-bg) !important; 
            padding: 0.75rem 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
        }
        .navbar-brand { font-size: 1.4rem; letter-spacing: -0.02em; }

        /* Table Styling */
        .table-container { 
            background: var(--card-bg); 
            padding: 1.5rem; 
            border-radius: 24px; 
            box-shadow: var(--card-shadow);
            max-height: 800px;
            overflow: auto;
            border: 1px solid var(--border-color);
        }
        
        .table { margin-bottom: 0; vertical-align: middle; color: var(--text-primary); }
        .table thead th {
            background: var(--card-bg);
            color: var(--text-secondary);
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.72rem;
            letter-spacing: 0.05em;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .table tbody td { padding: 1.25rem; font-size: 0.92rem; border-bottom: 1px solid var(--border-color); }
        .table-hover tbody tr:hover { background-color: rgba(59, 130, 246, 0.03); }

        /* Status Colors */
        .text-up { color: var(--success-color) !important; font-weight: 800; }
        .text-down { color: var(--danger-color) !important; font-weight: 800; }
        
        /* Signal Colors */
        .signal-bullish { color: var(--success-color); font-weight: 800; padding: 4px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; display: inline-block; }
        .signal-bearish { color: var(--danger-color); font-weight: 800; padding: 4px 12px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; display: inline-block; }
        .signal-oversold { color: #3b82f6; font-weight: 800; padding: 4px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; display: inline-block; }
        .signal-overbought { color: #f59e0b; font-weight: 800; padding: 4px 12px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; display: inline-block; }

        /* Watchlist Styling */
        .watchlist-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .watchlist-item:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .watchlist-item span { font-weight: 600; cursor: pointer; }
        .watchlist-item .remove-btn { color: rgba(255,255,255,0.4); cursor: pointer; border: none; background: none; padding: 0; }
        .watchlist-item .remove-btn:hover { color: var(--danger-color); }

        /* Modern Glass Select Improvement */
        .sidebar-content select, .sidebar-content input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #ffffff;
            font-weight: 600;
        }
        .sidebar-content select option { background: var(--sidebar-bg); color: white; }

        /* Professional Buttons */
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color), #3b82f6); 
            border: none; 
            border-radius: 16px; 
            padding: 0.85rem 1.75rem; 
            font-weight: 800;
            box-shadow: 0 4px 14px 0 rgba(30, 58, 138, 0.39);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 20px rgba(30, 58, 138, 0.3); 
            filter: brightness(1.1); 
        }
        
        .btn-package {
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            color: white !important;
            border: none;
            padding: 1rem 2rem;
            border-radius: 18px;
            font-weight: 800;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }
        .btn-package:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(124, 58, 237, 0.4); }

        /* Loading */
        .spinner-modern {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(30, 58, 138, 0.1);
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-0" style="z-index: 1001;">
        <div class="container-fluid px-5">
            <a class="navbar-brand fw-extrabold" href="/"><i class="fa-solid fa-gem me-2 text-info"></i> سامانه هوشمند سرمایه</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto gap-3">
                    <li class="nav-item">
                        <a class="nav-link py-2 px-4 active fw-bold" href="/"><i class="fa-solid fa-chart-pie me-2"></i> پیشخوان تحلیل</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link py-2 px-4" href="/api_test"><i class="fa-solid fa-bolt me-2"></i> عیب‌یابی وب‌سرویس</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Hidden container for chart rendering during export -->
        <div id="export_charts_container" style="position: absolute; left: -9999px; top: -9999px; width: 1200px;">
            <div id="chart_candle_export"></div>
            <div id="chart_trend_export"></div>
            <div id="chart_mom_export"></div>
            <div id="chart_vol_export"></div>
        </div>

        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-header">
                    <h4><i class="fa-solid fa-layer-group me-2"></i> مدیریت پورتفو</h4>
                    <div id="theme-toggle" title="تغییر تم بصری">
                        <i class="fa-solid fa-moon"></i>
                    </div>
                </div>
                
                <div class="sidebar-content">
                    <div class="section-title">بازار معاملاتی</div>
                    <div class="px-2">
                        <select id="asset_type" class="form-select mb-3">
                            <option value="">-- انتخاب دقیق بازار --</option>
                            <optgroup label="سهام و حق تقدم">
                                <option value="1">بورس تهران (TSE)</option>
                                <option value="2">فرابورس ایران (IFB)</option>
                                <option value="4">بازار پایه (Payeh)</option>
                            </optgroup>
                            <optgroup label="صندوق‌ها و اوراق">
                                <option value="5">صندوق‌های قابل معامله (ETF)</option>
                                <option value="fixed_income">اوراق درآمد ثابت/بدهی</option>
                                <option value="tashilat">تسهیلات مسکن (تسه)</option>
                            </optgroup>
                            <optgroup label="کالا و انرژی">
                                <option value="commodity">بورس کالا و آتی</option>
                                <option value="energy">بورس انرژی ایران</option>
                            </optgroup>
                            <optgroup label="شاخص‌ها">
                                <option value="indices_market">شاخص‌های کل و فرابورس</option>
                                <option value="indices_industry">شاخص‌های صنایع</option>
                            </optgroup>
                            <optgroup label="بازارهای جهانی و ارز">
                                <option value="tgju">طلا، ارز و کالا (TGJU)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="section-title">جستجوی نماد</div>
                    <div class="px-2 mb-3">
                        <div class="input-group">
                            <input type="text" id="symbol_search" class="form-control" placeholder="جستجوی سریع..." disabled>
                            <button id="btn_refresh_symbols" class="btn btn-outline-light" type="button"><i class="fa-solid fa-sync"></i></button>
                        </div>
                        <select id="symbol" class="form-select mt-2" disabled>
                            <option value="">ابتدا بازار...</option>
                        </select>
                    </div>

                    <div class="section-title">منو ابزارها</div>
                    <div id="analysis_list" class="nav flex-column mb-4">
                        <div class="nav-link active" data-value="technical" data-desc="تحلیل تکنیکال مولتی‌تایم‌فریم و شناسایی الگوها">
                            <i class="fa-solid fa-chart-line"></i> استودیو تکنیکال
                        </div>
                        <div class="nav-link" data-value="client_type" data-desc="رهگیری پول هوشمند و قدرت خریداران حقیقی">
                            <i class="fa-solid fa-user-secret"></i> تحلیل جریان پول
                        </div>
                        <div class="nav-link" data-value="transactions" data-desc="مانیتورینگ لحظه‌ای ریز معاملات">
                            <i class="fa-solid fa-microscope"></i> دیدبان معاملات
                        </div>
                        <div class="nav-link" data-value="codal" data-desc="بررسی آخرین اطلاعیه‌های کدال">
                            <i class="fa-solid fa-file-contract"></i> گزارشات کدال
                        </div>
                    </div>

                    <div class="section-title">دیده‌بان من</div>
                    <div id="watchlist_container" class="px-2">
                        <div id="watchlist_items" class="mb-3">
                            <!-- Watchlist items will be added here -->
                        </div>
                        <button id="btn_add_watchlist" class="btn btn-sm btn-outline-light w-100 rounded-4">
                            <i class="fa-solid fa-plus-circle me-1"></i> افزودن نماد
                        </button>
                    </div>

                    <div class="section-title">گوش بزنگی قیمت</div>
                    <div id="alerts_container" class="px-2">
                        <div id="alerts_list" class="mb-2"></div>
                        <div class="row g-1">
                            <div class="col-7">
                                <input type="number" id="alert_price" class="form-control form-control-sm" placeholder="قیمت هدف">
                            </div>
                            <div class="col-5">
                                <select id="alert_type" class="form-select form-select-sm">
                                    <option value="above">↑ عبور</option>
                                    <option value="below">↓ نزول</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn_add_alert" class="btn btn-sm btn-info w-100 mt-2 text-white fw-bold">
                            ثبت زنگ هشدار
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Dashboard Header -->
                <div class="row mb-5 align-items-center">
                    <div class="col-md-6">
                        <h1 class="fw-extrabold mb-1" style="font-size: 2.2rem; letter-spacing: -0.04em;">میز کار تحلیلی</h1>
                        <p class="text-secondary opacity-75">پایش هوشمند بازار سرمایه با استفاده از الگوریتم‌های پیشرفته</p>
                    </div>
                    <div class="col-md-6 d-flex justify-content-md-end align-items-center gap-4">
                        <div id="market_status_badge" class="px-4 py-2 rounded-pill bg-white border d-flex align-items-center gap-2">
                            <span class="pulse-green"></span>
                            <span class="small fw-bold text-success">بازار باز است</span>
                        </div>
                        <div class="text-end border-end pe-4">
                            <div class="h3 fw-black mb-0 font-monospace" id="current_time">--:--:--</div>
                            <div class="small text-secondary fw-bold">امروز</div>
                        </div>
                    </div>
                </div>

                <!-- Control Panel (Filters) -->
                <div class="card filter-card mb-5">
                    <div class="row g-4 align-items-end">
                        <div class="col-lg-3">
                            <label class="form-label"><i class="fa-solid fa-sliders me-2 text-primary"></i> پیکربندی تحلیل</label>
                            <select id="analysis_type_select" class="form-select">
                                <option value="technical">تکنیکال کلاسیک و مدرن</option>
                                <option value="history">بررسی تاریخچه قیمت</option>
                                <option value="client_type">ترکیب خریداران و فروشندگان</option>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label"><i class="fa-solid fa-calendar me-2 text-primary"></i> بازه زمانی (شمسی)</label>
                            <div class="input-group">
                                <input type="text" id="start_date" class="form-control text-center bg-white" placeholder="از تاریخ" data-jdp>
                                <span class="input-group-text border-0 bg-transparent"><i class="fa-solid fa-arrow-left"></i></span>
                                <input type="text" id="end_date" class="form-control text-center bg-white" placeholder="تا تاریخ" data-jdp>
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label"><i class="fa-solid fa-bars-staggered me-2 text-primary"></i> تعداد کندل</label>
                            <input type="number" id="candle_count" class="form-control text-center" value="100" min="1">
                        </div>
                        <div class="col-lg-3">
                            <div class="d-flex gap-3 mb-2 justify-content-center">
                                <div class="form-check form-switch custom-switch">
                                    <input class="form-check-input" type="checkbox" id="adjusted_prices" checked>
                                    <label class="form-check-label fw-bold" for="adjusted_prices">تعدیل قیمت</label>
                                </div>
                                <div class="form-check form-switch custom-switch">
                                    <input class="form-check-input" type="checkbox" id="force_refresh">
                                    <label class="form-check-label fw-bold text-danger" for="force_refresh">بروزرسانی زنده</label>
                                </div>
                            </div>
                            <button id="btn_fetch" class="btn btn-primary w-100 py-3">
                                <i class="fa-solid fa-wand-magic-sparkles me-2"></i> اجرای عملیات تحلیل
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Interactive Analysis Stats Container -->
                <div id="loading" class="text-center py-5">
                    <div class="spinner-modern mx-auto mb-4"></div>
                    <h3 class="fw-bold text-primary">هوش مصنوعی در حال پردازش...</h3>
                    <p class="text-secondary">در حال دریافت و تحلیل دیتای بازار، لطفاً منتظر بمانید</p>
                </div>

                <!-- Results Section -->
                <div id="result_container" style="display: none;">
                    <!-- Technical Summary Card -->
                    <div id="tech_summary_container" class="card p-0 mb-5 overflow-hidden border-0 shadow-lg" style="display: none;">
                        <div class="card-header bg-white border-bottom p-4 d-flex justify-content-between align-items-center">
                            <h4 class="fw-black mb-0 text-primary d-flex align-items-center">
                                <i class="fa-solid fa-square-poll-vertical me-3 fs-3"></i> عصاره تحلیل تکنیکال <span class="ms-2 badge bg-primary-soft text-primary fs-6 fw-bold">Snapshot</span>
                            </h4>
                            <div class="text-secondary small fw-bold">
                                <i class="fa-regular fa-clock me-1"></i> بروزرسانی: <span id="last_update_time">---</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4 text-center">
                                <div class="col-md-3">
                                    <div class="p-4 rounded-4 bg-light border-0 h-100 transition-hover">
                                        <div class="text-secondary small fw-bold mb-2 uppercase tracking-wider">سیگنال الگوریتم</div>
                                        <div id="summary_signal" class="h4 fw-black mb-0">---</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="p-4 rounded-4 bg-light border-0 h-100 transition-hover">
                                        <div class="text-secondary small fw-bold mb-2 uppercase tracking-wider">الگوی کندل‌استیک</div>
                                        <div id="summary_pattern" class="h4 fw-black mb-0 text-primary">---</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="p-4 rounded-4 bg-light border-0 h-100 transition-hover">
                                        <div class="text-secondary small fw-bold mb-2 uppercase tracking-wider">شاخص قدرت (RSI)</div>
                                        <div id="summary_rsi" class="h4 fw-black mb-0">---</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="p-4 rounded-4 bg-light border-0 h-100 transition-hover">
                                        <div class="text-secondary small fw-bold mb-2 uppercase tracking-wider">وضعیت روند</div>
                                        <div id="summary_trend" class="h4 fw-black mb-0">---</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Support & Resistance Section -->
                            <div class="row g-4 mt-4">
                                <div class="col-md-6">
                                    <div class="p-4 rounded-4 border-start border-danger border-4 bg-danger-soft h-100">
                                        <h6 class="fw-black text-danger mb-3 d-flex align-items-center">
                                            <i class="fa-solid fa-arrow-trend-up me-2"></i> سطوح مقاومتی (Supply Zones)
                                        </h6>
                                        <div id="summary_resistances" class="d-flex flex-wrap gap-2">---</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-4 rounded-4 border-start border-success border-4 bg-success-soft h-100">
                                        <h6 class="fw-black text-success mb-3 d-flex align-items-center">
                                            <i class="fa-solid fa-arrow-trend-down me-2"></i> سطوح حمایتی (Demand Zones)
                                        </h6>
                                        <div id="summary_supports" class="d-flex flex-wrap gap-2">---</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Metrics -->
                            <div class="row g-3 mt-4 text-center">
                                <div class="col-md-3">
                                    <div class="small text-secondary fw-bold">فیبوناتچی ۶۱.۸٪</div>
                                    <div id="summary_fib" class="h6 fw-black mt-1">---</div>
                                </div>
                                <div class="col-md-3 border-start">
                                    <div class="small text-secondary fw-bold"> ابر ایچیموکو</div>
                                    <div id="summary_ichimoku" class="h6 fw-black mt-1">---</div>
                                </div>
                                <div class="col-md-3 border-start">
                                    <div class="small text-secondary fw-bold">واگرایی (Divergence)</div>
                                    <div id="summary_divergence" class="h6 fw-black mt-1">---</div>
                                </div>
                                <div class="col-md-3 border-start">
                                    <div class="small text-secondary fw-bold">ضریب ریسک (Beta)</div>
                                    <div id="summary_beta" class="h6 fw-black mt-1">---</div>
                                </div>
                            </div>

                            <!-- Trade Strategy Card -->
                            <div class="row mt-5">
                                <div class="col-12">
                                    <div class="p-4 rounded-4 shadow-lg border-0 bg-primary position-relative overflow-hidden" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                                        <!-- Decorative Circle -->
                                        <div style="position: absolute; right: -50px; top: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mb-4 position-relative">
                                            <h5 class="fw-black text-white mb-0">
                                                <i class="fa-solid fa-compass text-warning me-2"></i> استراتژی معاملاتی پیشنهادی
                                            </h5>
                                            <span id="summary_rr_ratio" class="badge bg-white text-primary px-3 py-2 rounded-pill fw-black">R/R Ratio: ---</span>
                                        </div>
                                        <div class="row text-center g-3 position-relative">
                                            <div class="col-md-4">
                                                <div class="p-3 bg-white bg-opacity-10 rounded-4 border border-white border-opacity-10">
                                                    <div class="text-white text-opacity-75 small fw-bold mb-1">نقطه ورود بهینه</div>
                                                    <div id="summary_entry" class="h5 fw-black text-white mb-0">---</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="p-3 bg-white bg-opacity-10 rounded-4 border border-white border-opacity-10">
                                                    <div class="text-white text-opacity-75 small fw-bold mb-1">حد ضرر (Stop Loss)</div>
                                                    <div id="summary_sl" class="h5 fw-black text-warning mb-0">---</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="p-3 bg-white bg-opacity-10 rounded-4 border border-white border-opacity-10">
                                                    <div class="text-white text-opacity-75 small fw-bold mb-1">حد سود (Take Profit)</div>
                                                    <div id="summary_tp" class="h5 fw-black text-info mb-0">---</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart AI-Like Analysis Text -->
                            <div class="mt-4 p-4 rounded-4 border-0 style-ai-box" style="background: rgba(30, 58, 138, 0.04); border-right: 4px solid var(--primary-color) !important;">
                                <h6 class="fw-black text-primary mb-3 d-flex align-items-center">
                                    <i class="fa-solid fa-brain me-2 fa-beat"></i> استنتاج هوشمند سیستم:
                                </h6>
                                <div id="smart_analysis_text" class="text-secondary leading-relaxed text-justify small fw-medium" style="line-height: 2; font-size: 0.9rem;">
                                    در حال تجمیع و تحلیل نهایی پارامترها...
                                </div>
                            </div>
                        </div>
                    </div>

                        <!-- ML Indicator Prioritization -->
                        <div id="ml_prio_container" class="mt-5 p-4 rounded-4 bg-white shadow-sm border">
                            <h6 class="fw-black text-primary mb-4 d-flex align-items-center">
                                <i class="fa-solid fa-ranking-star text-warning me-2"></i> اولویت‌بندی هوشمند اندیکاتورها (Machine Learning)
                            </h6>
                            <div class="row g-3" id="ml_ranking_list">
                                <!-- Rankings will be injected here -->
                            </div>
                            <div class="alert alert-info border-0 bg-info-soft mt-3 mb-0 py-2 px-3 d-flex align-items-center rounded-4">
                                <i class="fa-solid fa-circle-question me-2"></i>
                                <span class="small fw-bold">سیستم بر اساس رفتار تاریخی این سهم، اندیکاتورهایی که بیشترین دقت (Accuracy) را در پیش‌بینی حرکت قیمت داشته‌اند رتبه‌بندی کرده است.</span>
                            </div>
                        </div>

                        <!-- 4D Strategy Matrix Table -->
                        <div id="strategy_matrix_container" class="mt-5 p-4 rounded-4 bg-white shadow-sm border" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="fw-black text-primary mb-0 d-flex align-items-center">
                                    <i class="fa-solid fa-shield-halved text-success me-2"></i> ماتریس استراتژی ۴ بعدی سرمایه‌گذاری
                                </h6>
                                <span class="badge bg-primary-soft text-primary px-3 py-2 rounded-pill fw-bold small">۱۲ پروفایل اختصاصی</span>
                            </div>
                            <div class="table-responsive rounded-4 border overflow-hidden">
                                <table class="table table-hover align-middle text-center mb-0">
                                    <thead class="bg-primary text-white">
                                        <tr class="small fw-black text-white">
                                            <th class="py-3">پروفایل سرمایه‌گذار</th>
                                            <th class="py-3">تیپ شخصیتی</th>
                                            <th class="py-3">افق زمانی</th>
                                            <th class="py-3">نقطه ورود</th>
                                            <th class="py-3">حد ضرر (SL)</th>
                                            <th class="py-3">حد سود (TP)</th>
                                            <th class="py-3" style="min-width: 250px;">توضیحات استراتژی</th>
                                        </tr>
                                    </thead>
                                    <tbody id="strategy_matrix_body" class="small fw-bold">
                                        <!-- Matrix will be injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                        <!-- Chart Container -->
                    <div id="chart_container" class="card p-4 mb-4" style="display: none;">
                        <h4 class="fw-bold mb-3 text-primary">نمودار تکنیکال و حجم (شمسی)</h4>
                        <div id="main_chart" style="min-height: 500px;"></div>
                        <div id="volume_chart" style="height: 250px; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px;"></div>
                    </div>

                    <!-- Indicator Charts Container -->
                    <div id="indicator_charts_container" class="row g-4 mb-4" style="display: none;">
                        <!-- Individual indicator charts will be injected here -->
                    </div>

                    <div class="card p-0 overflow-hidden border-0 shadow-lg mb-5">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center p-4 bg-white border-bottom gap-3">
                            <div>
                                <h4 id="result_title" class="fw-black mb-1 text-primary">پایگاه داده تحلیل</h4>
                                <p class="text-secondary small mb-0">نمایش جزئیات پارامترهای استخراج شده در بازه زمانی منتخب</p>
                            </div>
                            <div class="d-flex gap-3">
                                <button id="btn_package" class="btn btn-package d-flex align-items-center gap-2">
                                    <i class="fa-solid fa-cloud-arrow-down fs-5"></i> دریافت پکیج هوشمند تحلیل
                                </button>
                                <button id="btn_copy" class="btn btn-outline-secondary rounded-4 px-4">
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tabs for Daily/Weekly with professional look -->
                        <div id="tech_tabs_container" class="px-4 py-2 bg-white border-bottom d-flex justify-content-between align-items-center" style="display: none;">
                            <ul class="nav nav-pills gap-2" id="techTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active fw-black px-4 py-2 rounded-pill transition-all" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-pane" type="button" role="tab" onclick="switchTimeframe('daily')">روزانه (Daily)</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-black px-4 py-2 rounded-pill transition-all" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly-pane" type="button" role="tab" onclick="switchTimeframe('weekly')">هفتگی (Weekly)</button>
                                </li>
                            </ul>
                            <div class="ms-auto">
                                <span class="badge bg-light text-secondary border px-3 py-2 rounded-pill fw-bold">
                                    <i class="fa-solid fa-list-ol me-1"></i> تعداد رکورد: <span id="record_count" class="text-primary">---</span>
                                </span>
                            </div>
                        </div>

                        <div class="tab-content" id="techTabsContent">
                            <div class="tab-pane fade show active" id="daily-pane" role="tabpanel">
                                <div class="table-container">
                                    <table id="data_table" class="table table-striped table-hover">
                                        <thead id="table_head"></thead>
                                        <tbody id="table_body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="weekly-pane" role="tabpanel">
                                <div class="table-container">
                                    <table id="weekly_data_table" class="table table-striped table-hover">
                                        <thead id="weekly_table_head"></thead>
                                        <tbody id="weekly_table_body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // Initialize Jalali Datepicker
        const watchlistItems = document.getElementById('watchlist_items');
        const btnAddWatchlist = document.getElementById('btn_add_watchlist');
        jalaliDatepicker.startWatch({
            separatorChar: "-",
            minDate: "attr",
            maxDate: "attr"
        });

        const assetTypeSelect = document.getElementById('asset_type');
        const symbolSelect = document.getElementById('symbol');
        const symbolSearch = document.getElementById('symbol_search');
        const btnRefreshSymbols = document.getElementById('btn_refresh_symbols');
        const btnSyncRegistry = document.getElementById('btn_sync_registry');

        if (btnSyncRegistry) {
            btnSyncRegistry.addEventListener('click', async () => {
                const confirmMsg = "آیا مایل به بروزرسانی کامل دیتابیس نمادها هستید؟ این کار ممکن است چند دقیقه طول بکشد و از سهمیه درخواست‌های روزانه شما کسر کند.";
                if (!confirm(confirmMsg)) return;

                btnSyncRegistry.disabled = true;
                btnSyncRegistry.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> در حال همگام‌سازی...';
                
                try {
                    const response = await fetch('/api/sync_registry', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.status === 'completed') {
                        let successCount = 0;
                        let total = 0;
                        for (let k in result.details) {
                            if (result.details[k] === 'success') successCount++;
                            total++;
                        }
                        
                        showToast('پایان عملیات', `بروزرسانی کامل شد. (${successCount}/${total} بازار با موفقیت آپدیت شدند)`, 'success');
                    } else {
                        showToast('خطا', 'مشکلی در عملیات همگام‌سازی پیش آمد', 'danger');
                    }
                } catch (e) {
                    console.error(e);
                    showToast('خطای شبکه', 'عدم ارتباط با سرور محلی', 'danger');
                } finally {
                    btnSyncRegistry.disabled = false;
                    btnSyncRegistry.innerHTML = '<i class="fa-solid fa-cloud-arrow-down me-1"></i> بروزرسانی کل حافظه';
                }
            });
        }
        const serviceLinks = document.querySelectorAll('.nav-link[data-value]');
        const serviceDesc = document.getElementById('service_desc');
        const btnFetch = document.getElementById('btn_fetch');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result_container');
        const tableHead = document.getElementById('table_head');
        const themeToggle = document.getElementById('theme-toggle');

        // Theme Toggle Logic
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            setStorageItem('theme', newTheme);
        });

        // Load saved theme
        const savedTheme = getStorageItem('theme', 'light');
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';

        // Watchlist Logic
        // (Consolidated below in the script)

        const tableBody = document.getElementById('table_body');
        const weeklyTableHead = document.getElementById('weekly_table_head');
        const weeklyTableBody = document.getElementById('weekly_table_body');
        const codalCategoryContainer = document.getElementById('codal_category_container');
        const codalCategorySelect = document.getElementById('codal_category');

        let currentData = [];
        let currentWeeklyData = [];
        let allSymbols = [];
        let symbolBrowserCache = {}; // Local memory cache to prevent redundant fetches
        let activeService = 'technical';
        let currentTimeframe = 'daily';

        // Utility: Jalali Date Formatter
        const jalaliFormatter = (val) => {
            if (!val) return '---';
            
            try {
                const date = new Date(val);
                if (isNaN(date.getTime())) return val;
                
                // Use a more robust check for Persian locale support
                return new Intl.DateTimeFormat('fa-IR', {
                    calendar: 'persian',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(date);
            } catch (e) {
                console.error("Jalali Formatter Error:", e);
                return val;
            }
        };

        function switchTimeframe(tf) {
            currentTimeframe = tf;
            
            // Sync tabs
            const tabId = tf === 'weekly' ? 'weekly-tab' : 'daily-tab';
            const targetTab = document.getElementById(tabId);
            if (targetTab && !targetTab.classList.contains('active')) {
                const tab = new bootstrap.Tab(targetTab);
                tab.show();
            }

            // Update Summaries and Charts
            const dataToUse = tf === 'weekly' ? currentWeeklyData : currentData;
            if (dataToUse && dataToUse.length > 0) {
                const countEl = document.getElementById('record_count');
                if (countEl) countEl.textContent = dataToUse.length.toLocaleString();
                
                updateTechSummary(dataToUse);
                renderCandlestickChart(dataToUse);
                renderIndicatorCharts(dataToUse);
            }
        }

        function showToast(title, message, type = 'primary') {
            const container = document.getElementById('toast-container') || createToastContainer();
            const id = 'toast-' + Date.now();
            const html = `
                <div id="${id}" class="toast border-0 shadow-lg mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-${type} text-white border-0">
                        <i class="fa-solid fa-circle-info me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body bg-white text-dark small fw-bold">
                        ${message}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            const el = document.getElementById(id);
            const toast = new bootstrap.Toast(el, { delay: 4000 });
            toast.show();
            el.addEventListener('hidden.bs.toast', () => el.remove());
        }

        function createToastContainer() {
            const div = document.createElement('div');
            div.id = 'toast-container';
            div.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            div.style.zIndex = '1100';
            document.body.appendChild(div);
            return div;
        }

        // Tab switching listeners
        document.getElementById('daily-tab')?.addEventListener('click', () => switchTimeframe('daily'));
        document.getElementById('weekly-tab')?.addEventListener('click', () => switchTimeframe('weekly'));



        function updateTechSummary(data) {
            if (!data || data.length === 0) return;
            
            // Get the MOST RECENT record (last index)
            const latest = data[data.length - 1];

            const updateEl = document.getElementById('last_update_time');
            if (updateEl) updateEl.textContent = new Date().toLocaleTimeString('fa-IR');

            const sigEl = document.getElementById('summary_signal');
            if (sigEl) {
                const signalText = latest.Signal || 'خنثی';
                sigEl.textContent = signalText;
                let colorClass = 'text-secondary';
                if (signalText.includes('Bullish') || signalText.includes('خرید')) colorClass = 'text-success';
                else if (signalText.includes('Bearish') || signalText.includes('فروش')) colorClass = 'text-danger';
                sigEl.className = 'h4 fw-black mb-0 ' + colorClass;
            }
            
            const patternEl = document.getElementById('summary_pattern');
            if (patternEl) patternEl.textContent = latest.Pattern || '---';
            
            const rsiEl = document.getElementById('summary_rsi');
            if (rsiEl) rsiEl.textContent = latest.RSI || '---';
            
            const trendEl = document.getElementById('summary_trend');
            if (trendEl) {
                if (latest.SMA20 && latest.SMA50) {
                    trendEl.textContent = latest.SMA20 > latest.SMA50 ? 'صعودی' : 'نزولی';
                    trendEl.className = 'h4 fw-bold mb-0 ' + (latest.SMA20 > latest.SMA50 ? 'text-success' : 'text-danger');
                } else {
                    trendEl.textContent = '---';
                }
            }

            // Fibonacci
            const fibEl = document.getElementById('summary_fib');
            if (fibEl && latest.fibonacci) {
                fibEl.innerHTML = `<span class="text-primary">${latest.fibonacci['61.8%'].toLocaleString()} (61.8%)</span>`;
            }

            // Ichimoku
            const ichiEl = document.getElementById('summary_ichimoku');
            if (ichiEl) {
                let status = 'خنثی';
                if (latest.Ichimoku_Conv > latest.Ichimoku_Base) status = '<span class="text-success">صعودی</span>';
                else if (latest.Ichimoku_Conv < latest.Ichimoku_Base) status = '<span class="text-danger">نزولی</span>';
                ichiEl.innerHTML = status;
            }

            // Divergence
            const divEl = document.getElementById('summary_divergence');
            if (divEl) {
                divEl.innerHTML = latest.divergence === 'Bullish Divergence' ? '<span class="text-success">واگرایی مثبت</span>' : 
                                 latest.divergence === 'Bearish Divergence' ? '<span class="text-danger">واگرایی منفی</span>' : 'ندارد';
            }

            // Beta
            const betaEl = document.getElementById('summary_beta');
            if (betaEl) betaEl.textContent = latest.beta || '---';

            // Risk/Reward
            if (latest.risk_reward) {
                const rr = latest.risk_reward;
                document.getElementById('summary_rr_ratio').textContent = `R/R: ${rr.ratio}`;
                document.getElementById('summary_entry').textContent = rr.entry.toLocaleString();
                document.getElementById('summary_sl').textContent = rr.stop_loss.toLocaleString();
                document.getElementById('summary_tp').textContent = rr.take_profit.toLocaleString();
            }

            // Generate Smart Analysis Text
            let analysis = `بر اساس آخرین داده‌های دریافتی، نماد در وضعیت <b>${latest.Signal || 'خنثی'}</b> قرار دارد. `;
            if (latest.RSI < 30) analysis += "شاخص RSI نشان‌دهنده اشباع فروش است که می‌تواند فرصت خرید پله‌ای باشد. ";
            else if (latest.RSI > 70) analysis += "شاخص RSI در محدوده اشباع خرید قرار دارد، احتیاط در خرید توصیه می‌شود. ";
            
            if (latest.MACD > latest.MACD_Sig) analysis += "تقاطع مثبت در MACD تاییدکننده قدرت خریداران است. ";
            
            if (latest.divergence) analysis += `توجه: یک <b>${latest.divergence === 'Bullish Divergence' ? 'واگرایی مثبت' : 'واگرایی منفی'}</b> در اندیکاتور RSI مشاهده شد که نشانه بازگشت روند است. `;

            if (latest.risk_reward && latest.risk_reward.ratio > 2) {
                analysis += "با توجه به نسبت ریسک به ریوارد مناسب (بالای ۲)، ورود در این محدوده جذابیت فنی دارد. ";
            }
            
            if (latest.Ichimoku_Conv > latest.Ichimoku_Base) analysis += "همچنین خطوط ایچیموکو گارد صعودی به خود گرفته‌اند. ";

            const smartText = document.getElementById('smart_analysis_text');
            if (smartText) smartText.innerHTML = analysis;

            // Update S/R UI
            const resContainer = document.getElementById('summary_resistances');
            const supContainer = document.getElementById('summary_supports');
            
            if (resContainer && latest.resistances) {
                resContainer.innerHTML = latest.resistances.map(r => 
                    `<span class="badge bg-danger-soft text-danger border border-danger p-2">
                        ${r.value.toLocaleString()} <small>(قدرت: ${r.strength})</small>
                    </span>`
                ).join('');
            }
            if (supContainer && latest.supports) {
                supContainer.innerHTML = latest.supports.map(s => 
                    `<span class="badge bg-success-soft text-success border border-success p-2">
                        ${s.value.toLocaleString()} <small>(قدرت: ${s.strength})</small>
                    </span>`
                ).join('');
            }

            // Update ML Rankings
            const mlContainer = document.getElementById('ml_ranking_list');
            if (mlContainer && latest.recommended_indicators) {
                mlContainer.innerHTML = latest.recommended_indicators.slice(0, 4).map((ind, idx) => `
                    <div class="col-md-3">
                        <div class="p-3 border rounded-4 h-100 ${idx === 0 ? 'bg-primary-soft border-primary border-2' : 'bg-white shadow-sm'} transition-hover shadow-hover">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge ${idx === 0 ? 'bg-primary' : 'bg-primary-soft text-primary'} px-2 py-1 rounded-pill small">#${idx + 1}</span>
                                <span class="fw-black text-primary" style="font-size: 0.85rem;">${ind.accuracy}% دقت</span>
                            </div>
                            <h6 class="fw-black mb-1 text-dark">${ind.name}</h6>
                            <div class="text-secondary small fw-medium" style="font-size: 0.75rem; line-height: 1.4;">${ind.description}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function normalizePersian(text) {
            if (!text) return "";
            return text.toString()
                .replace(/ي/g, "ی")
                .replace(/ك/g, "ک")
                .replace(/‌/g, " ")
                .toLowerCase()
                .trim();
        }

        function updateServiceDesc() {
            const activeLink = document.querySelector('.nav-link.active[data-value]');
            if (activeLink) {
                serviceDesc.textContent = activeLink.dataset.desc || '';
                activeService = activeLink.dataset.value;
                codalCategoryContainer.style.display = (activeService === 'codal') ? 'block' : 'none';
                
                // Show timeframe only for technical analysis
                const timeframeFields = document.querySelector('[name="timeframe"]')?.closest('.col-lg-3');
                if (timeframeFields) {
                    timeframeFields.style.display = (activeService === 'technical') ? 'block' : 'none';
                }
            }
        }

        serviceLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (link.classList.contains('disabled')) return;
                
                const service = link.dataset.value;
                serviceLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                updateServiceDesc();
                
                // If switching to/from Codal, refresh symbol list to show/hide "All"
                if (allSymbols.length > 0) {
                    populateSymbolSelect(allSymbols);
                }

                if (service === 'technical' && !assetTypeSelect.value) {
                    alert('لطفاً ابتدا نوع بازار را انتخاب کنید.');
                }
            });
        });

        updateServiceDesc();

        function populateSymbolSelect(symbols) {
            if (!Array.isArray(symbols)) {
                console.error("populateSymbolSelect expected array, got:", symbols);
                symbols = [];
            }
            symbolSelect.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = symbols.length > 0 ? `انتخاب نماد (${symbols.length} مورد)...` : 'نمادی یافت نشد';
            symbolSelect.appendChild(defaultOpt);

            // Add "All" option for Indices or Codal
            if (symbols.length > 0 && (assetTypeSelect.value.startsWith('indices') || activeService === 'codal')) {
                const allOpt = document.createElement('option');
                allOpt.value = 'all';
                allOpt.textContent = '--- همه موارد ---';
                symbolSelect.appendChild(allOpt);
            }

            const fragment = document.createDocumentFragment();
            symbols.forEach(s => {
                const opt = document.createElement('option');
                const val = s.l18 || s.id || s.isin || '';
                opt.value = val;
                opt.setAttribute('data-id', s.id || s.isin || val);
                opt.textContent = `${s.l18 || '---'} (${s.l30 || '---'})`;
                fragment.appendChild(opt);
            });
            symbolSelect.appendChild(fragment);
            symbolSelect.disabled = false;

            // Better auto-selection logic
            if (symbols.length > 0) {
                if (assetTypeSelect.value.includes('indices')) {
                    // Indices usually use "all"
                    for (let i = 0; i < symbolSelect.options.length; i++) {
                        if (symbolSelect.options[i].value === 'all') {
                            symbolSelect.selectedIndex = i;
                            break;
                        }
                    }
                } else if (symbols.length === 1 && symbolSearch.value.trim() !== '') {
                    // If search has only one exact match, select it
                    symbolSelect.selectedIndex = symbolSelect.options.length - 1;
                }
            }
        }

        symbolSearch.addEventListener('input', () => {
            const term = normalizePersian(symbolSearch.value);
            if (!term) { populateSymbolSelect(allSymbols); return; }
            const filtered = allSymbols.filter(s => 
                (s.l18 && normalizePersian(s.l18).includes(term)) || 
                (s.l30 && normalizePersian(s.l30).includes(term)) ||
                (s.isin && s.isin.toLowerCase().includes(term)) ||
                (s.id && s.id.toString().includes(term))
            );
            populateSymbolSelect(filtered);
        });

        symbolSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (symbolSelect.value) {
                    btnFetch.click();
                }
            }
        });

        const loadSymbols = async (refresh = false) => {
            const val = assetTypeSelect.value;
            if (!val) {
                symbolSelect.innerHTML = '<option value="">ابتدا بازار را انتخاب کنید</option>';
                symbolSelect.disabled = true;
                return;
            }

            // FAST-SWITCH: If already fetched this session, use it instantly
            if (!refresh && symbolBrowserCache[val]) {
                allSymbols = symbolBrowserCache[val];
                populateSymbolSelect(allSymbols);
                return;
            }

            symbolSelect.innerHTML = `<option value="">در حال بارگذاری نمادها${refresh ? ' (بروزرسانی)' : ''}...</option>`;
            symbolSelect.disabled = true;
            symbolSearch.disabled = true;
            btnFetch.disabled = true;
            symbolSearch.value = '';
            // Don't clear allSymbols immediately to keep the UI stable if possible

            if (val.includes('indices')) {
                serviceLinks.forEach(link => {
                    const allowed = ['realtime', 'technical', 'history'];
                    if (!allowed.includes(link.dataset.value)) {
                        link.classList.add('disabled');
                    } else {
                        link.classList.remove('disabled');
                    }
                });
                const activeLink = document.querySelector('#analysis_list .nav-link.active');
                if (activeLink && activeLink.classList.contains('disabled')) {
                    document.querySelector('#analysis_list .nav-link[data-value="technical"]').click();
                }
            } else {
                serviceLinks.forEach(link => link.classList.remove('disabled'));
            }
            updateServiceDesc();

            try {
                const url = `/api/symbols/${val}${refresh ? '?refresh=true' : ''}`;
                console.log(`Fetching symbols from ${url}...`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`خطای سرور: ${response.status}`);
                }

                const symbols = await response.json();
                if (symbols.error) {
                    symbolSelect.innerHTML = `<option value="">خطا: ${symbols.error}</option>`;
                    if (refresh) {
                        alert(`مشکل در بروزرسانی: ${symbols.error}`);
                    }
                } else {
                    allSymbols = symbols;
                    symbolBrowserCache[val] = symbols; // Save to session cache
                    populateSymbolSelect(allSymbols);
                    if (refresh) {
                        showToast('بروزرسانی موفقیت‌آمیز', 'لیست نمادها با موفقیت آپدیت شد', 'success');
                    }
                }
            } catch (e) {
                symbolSelect.innerHTML = `<option value="">خطا در ارتباط با سرور</option>`;
                console.error(e);
            } finally {
                btnFetch.disabled = false;
                symbolSelect.disabled = false;
                symbolSearch.disabled = false;
                btnRefreshSymbols.innerHTML = '<i class="fa-solid fa-rotate"></i>';
                btnRefreshSymbols.disabled = false;
            }
        };

        btnRefreshSymbols.addEventListener('click', () => loadSymbols(true));
        assetTypeSelect.addEventListener('change', () => loadSymbols(false));
        
        document.getElementById('btn_add_watchlist')?.addEventListener('click', addToWatchlist);

        btnFetch.addEventListener('click', async () => {
            const assetType = assetTypeSelect.value;
            const symbol = symbolSelect.value;
            let serviceType = activeService;
            const candleCount = document.getElementById('candle_count').value;

            let startDate = document.getElementById('start_date').value;
            let endDate = document.getElementById('end_date').value;
            const adjusted = document.getElementById('adjusted_prices').checked;
            const force_refresh = document.getElementById('force_refresh').checked;

            if (startDate) startDate = startDate.replace(/\//g, '-');
            if (endDate) endDate = endDate.replace(/\//g, '-');

            if (!assetType) {
                alert('لطفا ابتدا بازار را انتخاب کنید');
                return;
            }
            if (!symbol) {
                alert('لطفا یک نماد را انتخاب کنید یا جستجو نمایید');
                return;
            }

            loading.style.display = 'block';
            resultContainer.style.display = 'none';
            btnFetch.disabled = true;
            
            // Clear previous data
            currentData = [];
            currentWeeklyData = [];

            try {
                if (serviceType === 'technical') {
                    // Fetch both formats simultaneously for instant switching
                    const [dailyRes, weeklyRes] = await Promise.all([
                        fetch('/api/fetch_data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                asset_type: assetType, symbol, service_type: 'technical',
                                start_date: startDate, end_date: endDate, adjusted,
                                timeframe: 'daily', candle_count: candleCount,
                                refresh: force_refresh
                            })
                        }).then(r => r.json()),
                        fetch('/api/fetch_data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                asset_type: assetType, symbol, service_type: 'technical',
                                start_date: startDate, end_date: endDate, adjusted,
                                timeframe: 'weekly', candle_count: candleCount,
                                refresh: force_refresh
                            })
                        }).then(r => r.json())
                    ]);

                    if (dailyRes.error || weeklyRes.error) {
                        alert('خطا: ' + (dailyRes.error || weeklyRes.error));
                    } else {
                        currentData = dailyRes;
                        currentWeeklyData = weeklyRes;
                        
                        // Default to daily for the table render but respect current toggle for the view
                        renderTable(currentData, currentWeeklyData);
                        switchTimeframe(currentTimeframe);

                        // Fetch Strategy Matrix independently
                        fetch('/api/ai_package', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol: symbol,
                                data: currentData,
                                weekly_data: currentWeeklyData
                            })
                        }).then(r => r.json()).then(res => {
                            if (res.strategy) {
                                renderStrategyMatrix(res.strategy);
                            }
                        }).catch(e => console.error("Strategy Fetch Error:", e));
                    }
                } else {
                    const response = await fetch('/api/fetch_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            asset_type: assetType,
                            symbol,
                            service_type: serviceType,
                            start_date: startDate,
                            end_date: endDate,
                            adjusted: adjusted,
                            candle_count: candleCount,
                            codal_category: codalCategorySelect.value,
                            refresh: force_refresh
                        })
                    });
                    currentData = await response.json();
                    if (currentData.error) {
                        alert('خطا: ' + currentData.error);
                    } else {
                        renderTable(currentData);
                    }
                }
                updateMarketStatus();
            } catch (e) {
                alert('خطا در دریافت داده');
            } finally {
                loading.style.display = 'none';
                btnFetch.disabled = false;
            }
        });

        function renderStrategyMatrix(matrix) {
            const body = document.getElementById('strategy_matrix_body');
            if (!body) return;
            body.innerHTML = '';
            
            matrix.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = idx % 2 === 0 ? 'bg-light-soft' : 'bg-white';
                
                const getRiskColor = (p) => {
                    if (p.includes('ریسک‌پذیر')) return 'text-danger';
                    if (p.includes('ریسک‌گریز')) return 'text-success';
                    return 'text-primary';
                };

                tr.innerHTML = `
                    <td class="fw-black ${getRiskColor(row['پروفایل سرمایه‌گذار'])} text-end py-3">${row['پروفایل سرمایه‌گذار']}</td>
                    <td class="text-secondary">${row['تیپ شخصیتی']}</td>
                    <td class="text-secondary">${row['افق زمانی']}</td>
                    <td class="text-primary fw-black">${typeof row['نقطه ورود'] === 'number' ? row['نقطه ورود'].toLocaleString() : row['نقطه ورود']}</td>
                    <td class="text-danger fw-black">${typeof row['حد ضرر (SL)'] === 'number' ? row['حد ضرر (SL)'].toLocaleString() : row['حد ضرر (SL)']}</td>
                    <td class="text-info fw-black">${typeof row['حد سود (TP)'] === 'number' ? row['حد سود (TP)'].toLocaleString() : row['حد سود (TP)']}</td>
                    <td class="text-start small fw-medium px-3 text-secondary" style="max-width:350px; line-height: 1.6;">${row['توضیحات استراتژی']}</td>
                `;
                body.appendChild(tr);
            });
        }

        function renderTable(data, weeklyData = null) {
            if (!data || data.length === 0) { 
                alert('داده‌ای یافت نشد. ممکن است برای این نماد در بازه زمانی انتخاب شده داده‌ای وجود نداشته باشد.'); 
                return; 
            }

            resultContainer.style.display = 'block';
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            weeklyTableHead.innerHTML = '';
            weeklyTableBody.innerHTML = '';

            // Handle Technical Analysis (Summary + Chart)
            const techSummary = document.getElementById('tech_summary_container');
            const chartContainer = document.getElementById('chart_container');
            const indicatorChartsContainer = document.getElementById('indicator_charts_container');
            const techTabs = document.getElementById('tech_tabs_container');
            const strategyContainer = document.getElementById('strategy_matrix_container');
            
            if (activeService === 'technical' && data.length > 0) {
                techSummary.style.display = 'block';
                chartContainer.style.display = 'block';
                indicatorChartsContainer.style.display = 'flex';
                techTabs.style.display = 'flex'; // Use flex for alignment
                if (strategyContainer) strategyContainer.style.display = 'block';
                
                // switchTimeframe is called after renderTable in the click handler
            } else {
                techSummary.style.display = 'none';
                chartContainer.style.display = 'none';
                indicatorChartsContainer.style.display = 'none';
                techTabs.style.display = 'none';
                if (strategyContainer) strategyContainer.style.display = 'none';
                
                if (activeService === 'client_type') {
                    renderClientTypeChart(data);
                } else if (activeService === 'transactions') {
                    renderTransactionChart(data);
                } else if (activeService === 'shareholders') {
                    renderShareholderChart(data);
                }
            }

            const persianKeys = {
                'l18': 'نماد', 'l30': 'نام کامل', 'pc': 'پایانی', 'pcc': 'تغییر', 'pcp': 'درصد',
                'pl': 'آخرین', 'plc': 'تغییر ل.', 'plp': 'درصد ل.', 'pf': 'اولین', 'py': 'دیروز',
                'pmin': 'کمترین', 'pmax': 'بیشترین', 'tno': 'تعداد', 'tvol': 'حجم', 'tval': 'ارزش',
                'time': 'زمان/تاریخ', 'date': 'تاریخ', 'eps': 'EPS', 'pe': 'P/E', 'bvol': 'حجم مبنا',
                'mv': 'ارزش بازار', 'z': 'تعداد سهام', 'isin': 'ISIN', 'cs': 'گروه', 'nav': 'NAV',
                'count': 'تعداد نماد', 'open': 'بازگشایی', 'high': 'بیشترین', 'low': 'کمترین',
                'close': 'پایانی', 'volume': 'حجم', 'SMA20': 'SMA20', 'SMA50': 'SMA50',
                'EMA20': 'EMA20', 'EMA50': 'EMA50', 'MACD': 'MACD', 'MACD_Sig': 'Signal',
                'ADX': 'ADX', 'RSI': 'RSI', 'STOCHk': 'StochK', 'STOCHd': 'StochD',
                'WILLR': 'WillR', 'ROC': 'ROC', 'MFI': 'MFI', 'BBU': 'BB Up', 'BBL': 'BB Low',
                'ATR': 'ATR', 'STDDEV': 'StdDev', 'KC_Upper': 'Keltner', 'DC_Upper': 'Donchian',
                'title': 'عنوان اطلاعیه', 'code': 'کد', 'date_publish': 'انتشار', 'link': 'لینک',
                'link_pdf': 'PDF', 'link_excel': 'Excel', 'link_attachment': 'پیوست',
                'Signal': 'سیگنال', 'Pattern': 'الگو'
            };

            const fillTable = (targetData, headEl, bodyEl) => {
                if (!targetData || targetData.length === 0) return;
                let keys = Object.keys(targetData[0]);
                if (activeService === 'technical') {
                    const priority = ['date', 'Signal', 'Pattern', 'close', 'RSI', 'MACD', 'SMA20', 'SMA50'];
                    keys = [
                        ...priority.filter(k => keys.includes(k)),
                        ...keys.filter(k => !priority.includes(k) && !['open', 'high', 'low', 'volume'].includes(k)),
                        ...['open', 'high', 'low', 'volume'].filter(k => keys.includes(k))
                    ];
                }

                const trHead = document.createElement('tr');
                keys.forEach(k => {
                    const th = document.createElement('th');
                    th.textContent = persianKeys[k] || k;
                    trHead.appendChild(th);
                });
                headEl.appendChild(trHead);

                targetData.forEach(row => {
                    const tr = document.createElement('tr');
                    keys.forEach(k => {
                        const td = document.createElement('td');
                        let val = row[k];
                        if (['pcp', 'plp', 'pcc', 'plc', 'index_change_percent', 'change_percent'].includes(k)) {
                            const num = parseFloat(val);
                            if (num > 0) td.className = 'text-up';
                            else if (num < 0) td.className = 'text-down';
                        }
                        if (k === 'Signal' && val) {
                            if (val.includes('Bullish')) td.className = 'signal-bullish';
                            else if (val.includes('Bearish')) td.className = 'signal-bearish';
                            else if (val.includes('Oversold')) td.className = 'signal-oversold';
                            else if (val.includes('Overbought')) td.className = 'signal-overbought';
                        }
                        if (k === 'Pattern' && val && val !== '---') td.className = 'fw-bold text-primary';
                        if (k.startsWith('link') && val && val.startsWith('http')) {
                            td.innerHTML = `<a href="${val}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2">مشاهده</a>`;
                        } else {
                            if (typeof val === 'number' && !['eps', 'pe', 'pcp', 'plp'].includes(k)) val = val.toLocaleString();
                            td.textContent = val || '---';
                        }
                        tr.appendChild(td);
                    });
                    bodyEl.appendChild(tr);
                });
            };

            fillTable(data, tableHead, tableBody);
            if (weeklyData) {
                fillTable(weeklyData, weeklyTableHead, weeklyTableBody);
            }

            // Check Alerts for the latest price
            if (data.length > 0 && data[0].l18) {
                const latest = data[0];
                checkAlerts(latest.l18, latest.pl || latest.pc);
            }
        }

        // --- Watchlist Logic ---
        function getStorageItem(key, defaultVal) {
            try {
                return localStorage.getItem(key) || defaultVal;
            } catch (e) {
                console.warn('Storage access blocked:', e);
                return defaultVal;
            }
        }
        
        function setStorageItem(key, val) {
            try {
                localStorage.setItem(key, val);
            } catch (e) {
                console.warn('Storage access blocked:', e);
            }
        }

        let watchlist = JSON.parse(getStorageItem('tse_watchlist', '[]'));
        
        function addToWatchlist() {
            const symbol = symbolSelect.value;
            if (!symbol || watchlist.includes(symbol)) return;
            watchlist.push(symbol);
            setStorageItem('tse_watchlist', JSON.stringify(watchlist));
            renderWatchlist();
        }

        window.removeFromWatchlist = function(symbol) {
            watchlist = watchlist.filter(s => s !== symbol);
            setStorageItem('tse_watchlist', JSON.stringify(watchlist));
            renderWatchlist();
        };

        function renderWatchlist() {
            const container = document.getElementById('watchlist_items');
            if (!container) return;
            container.innerHTML = watchlist.map(s => `
                <div class="watchlist-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="pointer" onclick="loadFromWatchlist('${s}')">${s}</span>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="removeFromWatchlist('${s}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        window.loadFromWatchlist = function(symbol) {
            symbolSearch.value = symbol;
            symbolSearch.dispatchEvent(new Event('input'));
            setTimeout(() => {
                for (let i = 0; i < symbolSelect.options.length; i++) {
                    if (symbolSelect.options[i].value === symbol) {
                        symbolSelect.selectedIndex = i;
                        btnFetch.click();
                        return;
                    }
                }
                if (symbolSelect.options.length > 1) {
                    symbolSelect.selectedIndex = symbolSelect.options.length - 1;
                    btnFetch.click();
                }
            }, 500);
        };

        if (btnAddWatchlist) btnAddWatchlist.addEventListener('click', addToWatchlist);

        // --- Charting Logic ---
        let mainChart = null;
        let volumeChart = null;
        let indicatorCharts = [];

        function renderCandlestickChart(data) {
            const container = document.getElementById('main_chart');
            const volContainer = document.getElementById('volume_chart');
            
            // Prefer interactive ApexCharts over static image for better UX/Localization
            if (data[0] && data[0].chart_image) {
                console.log("Static chart image available but skipping to use interactive ApexCharts.");
            }
            
            volContainer.style.display = 'block';
            container.innerHTML = '';
            volContainer.innerHTML = '';
            
            const sortedData = [...data].reverse();
            const chartData = sortedData.map(item => ({
                x: new Date(item.date || item.time).getTime(),
                y: [
                    parseFloat(item.open || item.pf || item.pc),
                    parseFloat(item.high || item.pmax || item.pc),
                    parseFloat(item.low || item.pmin || item.pc),
                    parseFloat(item.close || item.pc)
                ]
            }));

            const volumeData = sortedData.map(item => {
                const open = parseFloat(item.open || item.pf || item.pc || 0);
                const close = parseFloat(item.close || item.pc || 0);
                return {
                    x: new Date(item.date || item.time).getTime(),
                    y: parseFloat(item.volume || item.tvol || 0),
                    fillColor: close >= open ? '#22c55e' : '#ef4444',
                    strokeColor: close >= open ? '#22c55e' : '#ef4444'
                };
            });

            const options = {
                series: [{ name: 'قیمت', data: chartData }],
                chart: { 
                    type: 'candlestick', 
                    height: 450, 
                    id: 'price-chart', 
                    group: 'stock', 
                    toolbar: { show: true }, 
                    fontFamily: 'Vazirmatn',
                    animations: { enabled: false }
                },
                xaxis: { 
                    type: 'datetime', 
                    labels: { 
                        formatter: function(val) { return jalaliFormatter(val); },
                        style: { fontSize: '11px' },
                        hideOverlappingLabels: true,
                        rotate: -45,
                        rotateAlways: false
                    },
                    tooltip: { enabled: true },
                    axisBorder: { show: true, color: '#e0e0e0' }
                },
                yaxis: { 
                    labels: { 
                        formatter: (val) => val.toLocaleString(),
                        offsetY: 0
                    },
                    opposite: true
                },
                plotOptions: { 
                    candlestick: { 
                        colors: { upward: '#22c55e', downward: '#ef4444' },
                        wick: { useFillColor: true }
                    } 
                },
                tooltip: { 
                    shared: true,
                    custom: [
                        function({ seriesIndex, dataPointIndex, w }) {
                            const o = w.globals.seriesCandleO[seriesIndex][dataPointIndex];
                            const h = w.globals.seriesCandleH[seriesIndex][dataPointIndex];
                            const l = w.globals.seriesCandleL[seriesIndex][dataPointIndex];
                            const c = w.globals.seriesCandleC[seriesIndex][dataPointIndex];
                            const timestamp = w.globals.seriesX[seriesIndex][dataPointIndex];
                            const dateStr = jalaliFormatter(timestamp);
                            
                            return (
                                '<div class="p-2 border-0 bg-white text-dark shadow-sm rounded-3">' +
                                '<div class="text-muted border-bottom mb-1 pb-1 text-center font-monospace">' + dateStr + '</div>' +
                                '<div>باز: <b>' + o.toLocaleString() + '</b></div>' +
                                '<div>بیشترین: <b>' + h.toLocaleString() + '</b></div>' +
                                '<div>کمترین: <b>' + l.toLocaleString() + '</b></div>' +
                                '<div>بسته: <b>' + c.toLocaleString() + '</b></div>' +
                                '</div>'
                            );
                        }
                    ]
                }
            };

            const volOptions = {
                series: [{ name: 'حجم', data: volumeData }],
                chart: { 
                    type: 'bar', 
                    height: 180, 
                    id: 'vol-chart', 
                    group: 'stock', 
                    toolbar: { show: false }, 
                    fontFamily: 'Vazirmatn',
                    animations: { enabled: false }
                },
                xaxis: { 
                    type: 'datetime', 
                    labels: { 
                        formatter: function(val) { return jalaliFormatter(val); },
                        style: { fontSize: '11px' },
                        hideOverlappingLabels: true,
                        rotate: -45
                    },
                    axisBorder: { show: true, color: '#e0e0e0' }
                },
                yaxis: { 
                    labels: { 
                        formatter: (val) => {
                            if (val >= 1000000000) return (val/1000000000).toFixed(1) + 'B';
                            if (val >= 1000000) return (val/1000000).toFixed(1) + 'M';
                            if (val >= 1000) return (val/1000).toFixed(1) + 'K';
                            return val;
                        }
                    },
                    opposite: true
                },
                dataLabels: { enabled: false },
                plotOptions: {
                    bar: {
                        columnWidth: '80%',
                        distributed: false // Use individual colors from data
                    }
                },
                tooltip: { x: { formatter: function(val) { return jalaliFormatter(val); } } }
            };

            if (mainChart) mainChart.destroy();
            if (volumeChart) volumeChart.destroy();
            mainChart = new ApexCharts(container, options);
            volumeChart = new ApexCharts(volContainer, volOptions);
            mainChart.render();
            volumeChart.render();
        }

        function renderIndicatorCharts(data) {
            const container = document.getElementById('indicator_charts_container');
            container.innerHTML = '';
            indicatorCharts.forEach(c => c.destroy());
            indicatorCharts = [];

            const baseKeys = ['date', 'time', 'open', 'high', 'low', 'close', 'volume', 'l18', 'l30', 'isin', 'cs', 'cs_id', 'eps', 'pe', 'pc', 'pcc', 'pcp', 'pmin', 'pmax', 'count', 'Signal', 'Pattern'];
            const indicatorKeys = Object.keys(data[0]).filter(k => !baseKeys.includes(k) && typeof data[0][k] === 'number');
            
            const sortedData = [...data].reverse();

            // Define important levels for indicators
            const levelsMap = {
                'RSI': [
                    { y: 30, color: '#22c55e', label: 'اشباع فروش' },
                    { y: 70, color: '#ef4444', label: 'اشباع خرید' }
                ],
                'MACD': [{ y: 0, color: '#94a3b8', label: 'خط صفر' }],
                'STOCHk': [{ y: 20, color: '#22c55e' }, { y: 80, color: '#ef4444' }],
                'STOCHd': [{ y: 20, color: '#22c55e' }, { y: 80, color: '#ef4444' }],
                'WILLR': [{ y: -80, color: '#22c55e' }, { y: -20, color: '#ef4444' }],
                'MFI': [{ y: 20, color: '#22c55e' }, { y: 80, color: '#ef4444' }],
                'ROC': [{ y: 0, color: '#94a3b8' }],
                'ADX': [{ y: 25, color: '#f59e0b', label: 'شروع روند' }]
            };

            indicatorKeys.forEach(key => {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `<div class="card p-3"><h6 class="fw-bold mb-2">${key}</h6><div id="chart_${key}" style="height: 250px;"></div></div>`;
                container.appendChild(col);

                const annotations = [];
                if (levelsMap[key]) {
                    levelsMap[key].forEach(level => {
                        annotations.push({
                            y: level.y,
                            borderColor: level.color,
                            strokeDashArray: 4,
                            label: {
                                borderColor: level.color,
                                style: { color: '#fff', background: level.color, fontSize: '10px' },
                                text: level.label || ''
                            }
                        });
                    });
                }

                const options = {
                    series: [{ name: key, data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: d[key] })) }],
                    chart: { type: 'line', height: 250, toolbar: { show: false }, animations: { enabled: false }, fontFamily: 'Vazirmatn' },
                    stroke: { width: 2, curve: 'smooth' },
                    xaxis: { 
                        type: 'datetime', 
                        labels: { 
                            show: true,
                            formatter: function(val) { return jalaliFormatter(val); },
                            style: { fontSize: '9px' }
                        } 
                    },
                    yaxis: { labels: { show: true, style: { fontSize: '10px' } } },
                    colors: ['#2563eb'],
                    annotations: {
                        yaxis: annotations
                    }
                };

                const chart = new ApexCharts(document.getElementById(`chart_${key}`), options);
                chart.render();
                indicatorCharts.push(chart);
            });
        }

        let clientTypeChart = null;
        function renderClientTypeChart(data) {
            const container = document.getElementById('indicator_charts_container');
            // We use the indicator container but clear it first
            container.innerHTML = '<div class="col-12"><div class="card p-3"><h5 class="fw-bold mb-3">نمودار خرید و فروش حقیقی و حقوقی</h5><div id="client_chart" style="height: 400px;"></div></div></div>';
            container.style.display = 'flex';

            const sortedData = [...data].reverse();
            const options = {
                series: [
                    { name: 'خرید حقیقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: d.ct_buy_real_vol || 0 })) },
                    { name: 'فروش حقیقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: -(d.ct_sell_real_vol || 0) })) },
                    { name: 'خرید حقوقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: d.ct_buy_legal_vol || 0 })) },
                    { name: 'فروش حقوقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: -(d.ct_sell_legal_vol || 0) })) }
                ],
                chart: { type: 'bar', height: 400, stacked: true, toolbar: { show: true }, fontFamily: 'Vazirmatn' },
                colors: ['#22c55e', '#ef4444', '#3b82f6', '#f59e0b'],
                xaxis: { 
                    type: 'datetime',
                    labels: { formatter: function(val) { return jalaliFormatter(val); } }
                },
                yaxis: { labels: { formatter: (val) => Math.abs(val).toLocaleString() } },
                plotOptions: { bar: { horizontal: false, columnWidth: '80%' } },
                dataLabels: { enabled: false }
            };

            if (clientTypeChart) clientTypeChart.destroy();
            clientTypeChart = new ApexCharts(document.getElementById('client_chart'), options);
            clientTypeChart.render();
        }

        let transactionChart = null;
        function renderTransactionChart(data) {
            const container = document.getElementById('indicator_charts_container');
            container.innerHTML = '<div class="col-12"><div class="card p-3"><h5 class="fw-bold mb-3">نمودار ریزمعاملات امروز</h5><div id="trans_chart" style="height: 400px;"></div></div></div>';
            container.style.display = 'flex';

            const sortedData = [...data].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            const options = {
                series: [{ name: 'قیمت معامله', data: sortedData.map(d => ({ x: d.time, y: parseFloat(d.p || 0) })) }],
                chart: { type: 'line', height: 400, toolbar: { show: true }, fontFamily: 'Vazirmatn' },
                stroke: { width: 2, curve: 'stepline' },
                xaxis: { 
                    title: { text: 'زمان' },
                    labels: { style: { fontFamily: 'Vazirmatn' } }
                },
                yaxis: { labels: { formatter: (val) => val.toLocaleString() } },
                colors: ['#2563eb']
            };

            if (transactionChart) transactionChart.destroy();
            transactionChart = new ApexCharts(document.getElementById('trans_chart'), options);
            transactionChart.render();
        }

        let shareholderChart = null;
        function renderShareholderChart(data) {
            const container = document.getElementById('indicator_charts_container');
            container.innerHTML = '<div class="col-12"><div class="card p-3"><h5 class="fw-bold mb-3">ترکیب سهامداران عمده</h5><div id="share_chart" style="height: 400px;"></div></div></div>';
            container.style.display = 'flex';

            const options = {
                series: data.map(d => parseFloat(d.per || 0)),
                labels: data.map(d => d.shareholder || 'سایر'),
                chart: { type: 'pie', height: 400, fontFamily: 'Vazirmatn' },
                legend: { position: 'bottom' },
                dataLabels: { formatter: (val) => val.toFixed(1) + '%' }
            };

            if (shareholderChart) shareholderChart.destroy();
            shareholderChart = new ApexCharts(document.getElementById('share_chart'), options);
            shareholderChart.render();
        }

        // --- Price Alerts Logic ---
        let alerts = JSON.parse(getStorageItem('tse_alerts', '[]'));
        
        function addAlert() {
            const symbolSelect = document.getElementById('symbol');
            const symbol = symbolSelect?.value || '';
            const price = parseFloat(document.getElementById('alert_price')?.value);
            const type = document.getElementById('alert_type')?.value;

            if (!symbol || isNaN(price)) {
                alert('لطفا ابتدا یک نماد انتخاب کرده و قیمت هدف را وارد کنید');
                return;
            }

            alerts.push({ id: Date.now(), symbol, price, type, active: true });
            setStorageItem('tse_alerts', JSON.stringify(alerts));
            renderAlerts();
            const priceInput = document.getElementById('alert_price');
            if (priceInput) priceInput.value = '';
        }

        function removeAlert(id) {
            alerts = alerts.filter(a => a.id !== id);
            setStorageItem('tse_alerts', JSON.stringify(alerts));
            renderAlerts();
        }

        function renderAlerts() {
            const list = document.getElementById('alerts_list');
            if (!list) return;

            list.innerHTML = alerts.map(a => `
                <div class="watchlist-item d-flex justify-content-between align-items-center mb-2 p-1 border rounded bg-light" style="font-size: 0.75rem;">
                    <div>
                        <strong class="text-primary">${a.symbol}</strong> ${a.type === 'above' ? '↑' : '↓'} ${a.price.toLocaleString()}
                    </div>
                    <button class="btn btn-sm text-danger p-0 border-0" onclick="removeAlert(${a.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function checkAlerts(currentSymbol, currentPrice) {
            alerts.forEach(a => {
                if (a.active && a.symbol === currentSymbol) {
                    let triggered = false;
                    if (a.type === 'above' && currentPrice >= a.price) triggered = true;
                    if (a.type === 'below' && currentPrice <= a.price) triggered = true;

                    if (triggered) {
                        if (Notification.permission === "granted") {
                            new Notification(`هشدار قیمت: ${a.symbol}`, { body: `قیمت به ${currentPrice.toLocaleString()} رسید.` });
                        } else {
                            alert(`🔔 هشدار قیمت: ${a.symbol} به ${currentPrice.toLocaleString()} رسید!`);
                        }
                        a.active = false;
                        setStorageItem('tse_alerts', JSON.stringify(alerts));
                        renderAlerts();
                    }
                }
            });
        }

        if (Notification.permission !== "denied") Notification.requestPermission();

        // --- Symbol Comparison Logic ---
        let compareList = [];
        function addToCompare() {
            const symbol = symbolSelect.value;
            if (!symbol || compareList.includes(symbol)) return;
            if (compareList.length >= 3) { alert('حداکثر ۳ نماد برای مقایسه'); return; }
            compareList.push(symbol);
            updateCompareUI();
        }

        function updateCompareUI() {
            const container = document.getElementById('compare_tags');
            container.innerHTML = compareList.map(s => `
                <span class="badge bg-info me-1">
                    ${s} <i class="fas fa-times ms-1 pointer" onclick="removeFromCompare('${s}')"></i>
                </span>
            `).join('');
        }

        function removeFromCompare(symbol) {
            compareList = compareList.filter(s => s !== symbol);
            updateCompareUI();
        }

        async function runComparison() {
            if (compareList.length < 2) { alert('حداقل ۲ نماد برای مقایسه انتخاب کنید'); return; }
            const resultsDiv = document.getElementById('comparison_results');
            resultsDiv.innerHTML = '<div class="spinner-border text-primary"></div>';
            try {
                const promises = compareList.map(s => fetch('/api/fetch_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asset_type: assetTypeSelect.value, symbol: s, service_type: 'realtime' })
                }).then(r => r.json()));
                const datasets = await Promise.all(promises);
                
                let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>فاکتور</th>';
                compareList.forEach(s => html += `<th>${s}</th>`);
                html += '</tr></thead><tbody>';

                const factors = [
                    { label: 'آخرین قیمت', key: 'pl' },
                    { label: 'تغییر قیمت', key: 'pcp', suffix: '%' },
                    { label: 'RSI (14)', key: 'RSI' },
                    { label: 'حجم معاملات', key: 'tvol' }
                ];

                factors.forEach(f => {
                    html += `<tr><td>${f.label}</td>`;
                    datasets.forEach(d => {
                        const val = d[0] ? d[0][f.key] : 'N/A';
                        html += `<td>${val}${f.suffix || ''}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
            } catch (e) { resultsDiv.innerHTML = '<div class="alert alert-danger">خطا در مقایسه نمادها</div>'; }
        }

        // --- Market Status & Time ---
        async function updateMarketStatus() {
            try {
                const response = await fetch('/api/market_status');
                const data = await response.json();
                const badge = document.getElementById('market_status_badge');
                badge.innerHTML = `<i class="fa-solid fa-circle fa-fade me-1"></i> بازار: ${data.status}`;
                document.getElementById('current_time').textContent = data.time;
                
                if (data.stats) {
                    document.getElementById('stat_total').textContent = data.stats.global.total;
                    document.getElementById('stat_blocked').textContent = data.stats.global.blocked;
                    document.getElementById('api_stats').classList.remove('d-none');
                    
                    // Update modal table
                    const tableBody = document.getElementById('stats_table_body');
                    if (tableBody) {
                        tableBody.innerHTML = '';
                        for (const [svc, s] of Object.entries(data.stats.services)) {
                            const successRate = s.total > 0 ? Math.round((s.success / s.total) * 100) : 0;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${svc}</td>
                                <td>${s.total}</td>
                                <td class="text-success">${s.success}</td>
                                <td class="text-danger">${s.blocked}</td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" style="width: ${successRate}%"></div>
                                    </div>
                                    <small>${successRate}%</small>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        }
                    }

                    // Update tooltip with per-service details
                    let details = 'جزئیات سرویس‌ها:\n';
                    for (const [svc, s] of Object.entries(data.stats.services)) {
                        details += `${svc}: ${s.success}/${s.total} (مسدود: ${s.blocked})\n`;
                    }
                    document.getElementById('api_stats').title = details;
                }
            } catch (e) {}
        }
        // setInterval(updateMarketStatus, 10000); // Removed as per user request: No automatic requests
        updateMarketStatus();

        // Initialize
        renderWatchlist();
        renderAlerts();
        
        // Add Clock/Date Logic
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }).format(now);
            
            const timeEl = document.getElementById('current_time');
            if (timeEl) {
                timeEl.innerText = timeStr;
                const dateEl = timeEl.nextElementSibling;
                if (dateEl) dateEl.innerText = dateStr;
            }
        }
        setInterval(updateClock, 1000);
        updateClock();

        function getFilename() {
            const symbol = symbolSelect.value || 'Export';
            const today = new Date().toISOString().split('T')[0];
            return `TSETMC-${symbol}-${today}`;
        }

        async function downloadPackage() {
            if (!currentData || currentData.length === 0) {
                alert('ابتدا داده‌ها را دریافت کنید');
                return;
            }

            const btn = document.getElementById('btn_package');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> در حال آماده‌سازی بسته...';
            btn.disabled = true;

            try {
                // 1. Get AI Analysis Report first
                const aiResponse = await fetch('/api/ai_package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: symbolSelect.value, 
                        data: currentData,
                        weekly_data: currentWeeklyData
                    })
                });
                const aiResult = await aiResponse.json();
                
                // 2. Request comprehensive ZIP from server
                const response = await fetch('/api/download_comprehensive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: symbolSelect.value,
                        daily_data: currentData, 
                        weekly_data: currentWeeklyData,
                        markdown: aiResult.markdown
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
                    saveAs(blob, `AI_Package_${symbolSelect.value}_${timestamp}.zip`);
                } else {
                    const err = await response.json();
                    alert('خطا در تولید بسته: ' + (err.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('خطا در ارتباط با سرور جهت تولید بسته');
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        document.getElementById('btn_package').addEventListener('click', downloadPackage);
    </script>
    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">آمار دقیق درخواست‌ها به تفکیک سرویس</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>سرویس</th>
                                    <th>کل درخواست‌ها</th>
                                    <th>موفق</th>
                                    <th>مسدود شده</th>
                                    <th>نرخ موفقیت</th>
                                </tr>
                            </thead>
                            <tbody id="stats_table_body">
                                <!-- Stats will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info small">
                        <i class="fa-solid fa-info-circle me-1"></i>
                        درخواست‌های مسدود شده به دلیل محدودیت‌های سرور (Throttling) هستند. سرویس تحلیل تکنیکال اولویت بالاتری دارد.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
