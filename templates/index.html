<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه تحلیل پیشرفته TSETMC</title>
    <link rel="icon" href="data:,">
    <!-- Fonts & Icons -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --bg-light: #f1f5f9;
            --sidebar-bg: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-light: #0f172a;
            --sidebar-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        body { 
            background-color: var(--bg-light); 
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* Sidebar Styling */
        .sidebar { 
            background: var(--sidebar-bg); 
            min-height: 100vh; 
            padding: 0;
            border-left: 1px solid var(--border-color); 
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 0.3s ease;
        }
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h4 { font-weight: 800; margin: 0; font-size: 1.25rem; }
        
        #theme-toggle {
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.2s;
        }
        #theme-toggle:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }

        .sidebar-content { padding: 0 1rem 2rem 1rem; }

        .nav-link { 
            color: var(--text-secondary); 
            padding: 0.75rem 1rem; 
            border-radius: 12px; 
            margin-bottom: 4px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        .nav-link i { width: 20px; text-align: center; font-size: 1.1rem; }
        .nav-link:hover { background-color: var(--bg-light); color: var(--primary-color); transform: translateX(-4px); }
        .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .nav-link.disabled { opacity: 0.4; cursor: not-allowed; }

        .section-title { 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: var(--text-secondary); 
            margin: 1.5rem 1rem 0.75rem 1rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
        }

        /* Main Content */
        .main-content { padding: 2rem; }
        
        .card { 
            border-radius: 20px; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .filter-card { margin-bottom: 2rem; }

        .form-label { font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-control, .form-select {
            background-color: var(--sidebar-bg);
            color: var(--text-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
            transition: all 0.2s;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--sidebar-bg);
            color: var(--text-primary);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Table Styling */
        .table-container { 
            background: var(--sidebar-bg); 
            padding: 1.5rem; 
            border-radius: 24px; 
            box-shadow: var(--card-shadow);
            max-height: 700px;
            overflow: auto;
            border: 1px solid var(--border-color);
        }
        
        .table { margin-bottom: 0; vertical-align: middle; color: var(--text-primary); }
        .table thead th {
            background: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .table tbody td { padding: 1rem; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); }
        .table-striped tbody tr:nth-of-type(odd) { background-color: var(--bg-light); }
        .table-hover tbody tr:hover { background-color: var(--border-color); }

        /* Status Colors */
        .text-up { color: var(--success-color) !important; font-weight: 700; }
        .text-down { color: var(--danger-color) !important; font-weight: 700; }
        
        /* Signal Colors */
        .signal-bullish { color: var(--success-color); font-weight: bold; }
        .signal-bearish { color: var(--danger-color); font-weight: bold; }
        .signal-oversold { color: #3b82f6; font-weight: bold; }
        .signal-overbought { color: #f59e0b; font-weight: bold; }

        /* Watchlist Styling */
        .watchlist-item {
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .watchlist-item:hover { background: var(--primary-color); color: white; }
        .watchlist-item .remove-item { cursor: pointer; opacity: 0.6; }
        .watchlist-item .remove-item:hover { opacity: 1; color: #ff4d4d; }

        .badge-up { background-color: #dcfce7; color: #166534; }
        .badge-down { background-color: #fee2e2; color: #991b1b; }

        .bg-success-soft { background-color: rgba(34, 197, 94, 0.1); }
        .bg-danger-soft { background-color: rgba(239, 68, 68, 0.1); }

        /* Sidebar Glassmorphism */
        .sidebar-content select, .sidebar-content input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
        }

        /* Buttons Tooltips/Hover */
        .pointer { cursor: pointer; }
        
        .btn-group .btn {
            border-radius: 10px;
            font-size: 0.85rem;
            padding: 0.5rem;
        }

        /* Responsive Improvements */
        @media (max-width: 992px) {
            .sidebar {
                position: relative;
                min-height: auto;
                border-left: none;
                border-bottom: 2px solid var(--border-color);
            }
        }

        /* Custom scrollbar for sidebar */
        .sidebar { overflow-y: auto; max-height: 100vh; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

        /* Buttons */
        .btn-primary { 
            background-color: var(--primary-color); 
            border: none; 
            border-radius: 12px; 
            padding: 0.75rem 1.5rem; 
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
            transition: all 0.3s;
        }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        
        .btn-download { 
            border-radius: 10px; 
            font-weight: 600; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            padding: 0.5rem 1rem;
        }

        /* Loading Animation */
        #loading { padding: 4rem 0; display: none; }
        .spinner-modern {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .sidebar { min-height: auto; border-left: none; border-bottom: 1px solid #e2e8f0; }
            .main-content { padding: 1rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-0" style="z-index: 1001;">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="/"><i class="fa-solid fa-brain me-2"></i> هوش مالی TSETMC</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active fw-bold" href="/"><i class="fa-solid fa-chart-line me-1"></i> تحلیل تکنیکال</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api_test"><i class="fa-solid fa-vial me-1"></i> تست وب‌سرویس</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Hidden container for chart rendering during export -->
        <div id="export_charts_container" style="position: absolute; left: -9999px; top: -9999px; width: 1200px;">
            <div id="chart_candle_export"></div>
            <div id="chart_trend_export"></div>
            <div id="chart_mom_export"></div>
            <div id="chart_vol_export"></div>
        </div>

        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-header">
                    <h4><i class="fa-solid fa-brain me-2"></i> هوش مالی</h4>
                    <div id="theme-toggle" title="تغییر تم">
                        <i class="fa-solid fa-moon"></i>
                    </div>
                </div>
                
                <div class="sidebar-content">
                    <div class="section-title">انتخاب بازار</div>
                    <div class="px-2">
                        <select id="asset_type" class="form-select mb-3">
                            <option value="">انتخاب بازار...</option>
                            <optgroup label="بازارهای اصلی">
                                <option value="1">بورس تهران</option>
                                <option value="2">فرابورس ایران</option>
                                <option value="5">صندوق‌های ETF</option>
                                <option value="fixed_income">درآمد ثابت</option>
                                <option value="3">بورس کالا و آتی</option>
                                <option value="tashilat">تسهیلات مسکن</option>
                            </optgroup>
                            <optgroup label="بازارهای پایه">
                                <option value="4">بازار پایه</option>
                            </optgroup>
                            <optgroup label="شاخص‌ها">
                                <option value="indices_market">شاخص‌های کل</option>
                                <option value="indices_industry">شاخص‌های صنایع</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="section-title">جستجوی نماد</div>
                    <div class="px-2 mb-3">
                        <div class="input-group input-group-sm">
                            <input type="text" id="symbol_search" class="form-control" placeholder="جستجو..." disabled>
                            <button id="btn_refresh_symbols" class="btn btn-outline-primary" type="button"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                        <select id="symbol" class="form-select form-select-sm mt-2" disabled>
                            <option value="">ابتدا بازار...</option>
                        </select>
                    </div>

                    <div class="section-title">ابزارهای تحلیلی</div>
                    <div id="analysis_list" class="nav flex-column px-2 mb-3">
                        <div class="nav-link active" data-value="technical" data-desc="تحلیل تکنیکال جامع (۱۸ اندیکاتور در ۳ بعد روند، شتاب و نوسان)">
                            <i class="fa-solid fa-chart-line"></i> تحلیل تکنیکال
                        </div>
                        <div class="nav-link" data-value="client_type" data-desc="تحلیل رفتار حقیقی و حقوقی (پول هوشمند و سرانه خرید)">
                            <i class="fa-solid fa-users-gear"></i> ترکیب خریداران
                        </div>
                        <div class="nav-link" data-value="transactions" data-desc="مشاهده ریز معاملات روزانه و تشخیص کد به کد">
                            <i class="fa-solid fa-list-check"></i> ریز معاملات
                        </div>
                        <div class="nav-link" data-value="shareholders" data-desc="تغییرات سهامداران عمده و مالکان بالای یک درصد">
                            <i class="fa-solid fa-handshake"></i> سهامداران عمده
                        </div>
                        <div class="nav-link" data-value="codal" data-desc="اطلاعیه‌های شبکه کدال و گزارش‌های دوره‌ای شرکت">
                            <i class="fa-solid fa-envelope-open-text"></i> اطلاعیه‌های کدال
                        </div>
                        <div class="nav-link" data-value="nav" data-desc="محاسبه خالص ارزش دارایی‌ها (مخصوص صندوق‌های ETF)">
                            <i class="fa-solid fa-scale-balanced"></i> محاسبه NAV
                        </div>
                    </div>

                    <div class="section-title">دیده‌بان من</div>
                    <div id="watchlist_container" class="px-2">
                        <div id="watchlist_items" class="d-flex flex-wrap gap-1 mb-2">
                            <!-- Watchlist items will be added here -->
                        </div>
                        <button id="btn_add_watchlist" class="btn btn-sm btn-outline-primary w-100 rounded-pill mb-2">
                            <i class="fa-solid fa-plus me-1"></i> افزودن به دیده‌بان
                        </button>
                    </div>

                    <div class="section-title">هشدارهای قیمت</div>
                    <div id="alerts_container" class="px-2">
                        <div id="alerts_list" class="mb-2"></div>
                        <div class="row g-1">
                            <div class="col-8">
                                <input type="number" id="alert_price" class="form-control form-control-sm" placeholder="قیمت هدف...">
                            </div>
                            <div class="col-4">
                                <select id="alert_type" class="form-select form-select-sm">
                                    <option value="above">↑بالا</option>
                                    <option value="below">↓پایین</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn_add_alert" class="btn btn-sm btn-primary w-100 mt-2">
                            <i class="fa-solid fa-plus me-1"></i> ثبت هشدار
                        </button>
                    </div>
                    
                    <div class="mt-4 p-3 bg-light rounded-4 small text-muted border">
                        <i class="fa-solid fa-circle-info me-1"></i>
                        <span id="service_desc"></span>
                    </div>
                    
                    <div class="mt-3 px-2">
                        <button class="btn btn-sm btn-outline-secondary w-100 rounded-pill mb-2" data-bs-toggle="modal" data-bs-target="#statsModal">
                            <i class="fa-solid fa-chart-pie me-1"></i> آمار درخواست‌ها
                        </button>
                        <button id="btn_sync_registry" class="btn btn-sm btn-outline-warning w-100 rounded-pill">
                            <i class="fa-solid fa-cloud-arrow-down me-1"></i> بروزرسانی کل حافظه
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Header Info -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-1">داشبورد تحلیل بازار</h2>
                        <p class="text-muted mb-0">دسترسی هوشمند به داده‌های بورس اوراق بهادار تهران</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div id="api_stats" class="bg-white border rounded-pill px-3 py-2 small text-muted d-none d-md-flex align-items-center">
                            <i class="fa-solid fa-chart-line me-2 text-primary"></i>
                            <span>درخواست‌ها: <b id="stat_total">0</b></span>
                            <span class="mx-2">|</span>
                            <span>مسدود شده: <b id="stat_blocked" class="text-danger">0</b></span>
                        </div>
                        <div id="market_status_badge" class="badge bg-success-soft text-success px-3 py-2 rounded-pill border border-success">
                            <i class="fa-solid fa-circle fa-fade me-1"></i> بازار: در حال فعالیت
                        </div>
                        <div class="text-end">
                            <div class="fw-bold" id="current_time">--:--:--</div>
                            <div class="small text-muted">امروز</div>
                        </div>
                    </div>
                </div>

                <!-- Filters Card -->
                <div class="card filter-card p-4">
                    <div class="row g-4 align-items-end">
                        <div class="col-lg-3">
                            <label class="form-label"><i class="fa-solid fa-list-check me-1"></i> نوع خروجی تحلیل</label>
                            <select id="analysis_type_select" class="form-select">
                                <option value="technical">تحلیل تکنیکال پیشرفته</option>
                                <option value="history">تاریخچه قیمتی</option>
                                <option value="client_type">حقیقی-حقوقی</option>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label"><i class="fa-solid fa-calendar-days me-1"></i> بازه تاریخ (شمسی)</label>
                            <div class="input-group">
                                <input type="text" id="start_date" class="form-control text-center" placeholder="از تاریخ" data-jdp>
                                <span class="input-group-text bg-white border-start-0 border-end-0"><i class="fa-solid fa-arrow-left-long"></i></span>
                                <input type="text" id="end_date" class="form-control text-center" placeholder="تا تاریخ" data-jdp>
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label"><i class="fa-solid fa-hashtag me-1"></i> تعداد کندل</label>
                            <input type="number" id="candle_count" class="form-control text-center" value="100" min="1">
                        </div>
                        <div id="codal_category_container" class="col-lg-3" style="display: none;">
                            <label class="form-label">دسته‌بندی کدال</label>
                            <select id="codal_category" class="form-select">
                                <option value="">همه موارد</option>
                                <option value="1">صورت‌های مالی</option>
                                <option value="2">افشای اطلاعات بااهمیت</option>
                                <option value="3">گزارش فعالیت ماهانه</option>
                                <option value="4">اساسنامه و امیدنامه</option>
                                <option value="5">هیئت مدیره و کمیته حسابرسی</option>
                                <option value="6">آگهی دعوت به مجمع</option>
                                <option value="7">تصمیمات مجمع</option>
                                <option value="8">افزایش سرمایه</option>
                                <option value="9">شفاف‌سازی</option>
                                <option value="10">سایر اطلاعیه‌ها</option>
                            </select>
                        </div>
                        <div class="col-lg-3 d-flex flex-column gap-2 justify-content-end">
                            <div class="d-flex gap-3 mb-1">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="adjusted_prices" checked>
                                    <label class="form-check-label fw-bold" for="adjusted_prices">تعدیل</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="force_refresh">
                                    <label class="form-check-label fw-bold text-danger" for="force_refresh">بروزرسانی انلاین</label>
                                </div>
                            </div>
                            <button id="btn_fetch" class="btn btn-primary w-100">
                                <i class="fa-solid fa-bolt me-2"></i> شروع تحلیل هوشمند
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading" class="text-center">
                    <div class="spinner-modern"></div>
                    <h5 class="fw-bold text-primary">در حال پردازش درخواست...</h5>
                    <p class="text-muted">لطفاً شکیبا باشید، داده‌ها در حال دریافت از سرور هستند.</p>
                </div>

                <!-- Results Section -->
                <div id="result_container" style="display: none;">
                    <!-- Technical Summary Card -->
                    <div id="tech_summary_container" class="card p-4 mb-4" style="display: none;">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted mb-1">سیگنال هوشمند</div>
                                <div id="summary_signal" class="h4 fw-bold mb-0">---</div>
                            </div>
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted mb-1">الگوی شمعی</div>
                                <div id="summary_pattern" class="h4 fw-bold mb-0">---</div>
                            </div>
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted mb-1">شاخص RSI</div>
                                <div id="summary_rsi" class="h4 fw-bold mb-0">---</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="small text-muted mb-1">روند (SMA)</div>
                                <div id="summary_trend" class="h4 fw-bold mb-0">---</div>
                            </div>
                        </div>

                        <!-- Support & Resistance Section -->
                        <div class="row g-3 mt-3 border-top pt-3">
                            <div class="col-md-6 border-start">
                                <h6 class="fw-bold text-danger mb-2"><i class="fa-solid fa-arrow-up"></i> ۵ مقاومت پیش رو:</h6>
                                <div id="summary_resistances" class="d-flex flex-wrap gap-2 small">---</div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold text-success mb-2"><i class="fa-solid fa-arrow-down"></i> ۵ حمایت معتبر:</h6>
                                <div id="summary_supports" class="d-flex flex-wrap gap-2 small">---</div>
                            </div>
                        </div>

                        <!-- Advanced Analyst metrics (Ichimoku, Divergence, Fib, RR) -->
                        <div class="row g-3 mt-4 border-top pt-4">
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted mb-1">حمایت/مقاومت فیبوناتچی</div>
                                <div id="summary_fib" class="small fw-bold mb-0">---</div>
                            </div>
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted mb-1">وضعیت ایچیموکو</div>
                                <div id="summary_ichimoku" class="small fw-bold mb-0">---</div>
                            </div>
                            <div class="col-md-3 text-center border-start">
                                <div class="small text-muted mb-1">واگرایی (Divergence)</div>
                                <div id="summary_divergence" class="small fw-bold mb-0">---</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="small text-muted mb-1">ضریب بتا (Beta)</div>
                                <div id="summary_beta" class="small fw-bold mb-0">---</div>
                            </div>
                        </div>

                        <!-- Trade Strategy Card -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="p-3 bg-dark text-white rounded-4 shadow-sm border border-secondary">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="fw-bold mb-0"><i class="fa-solid fa-bullseye text-warning me-1"></i> استراتژی معاملاتی پیشنهادی (Risk to Reward)</h6>
                                        <span id="summary_rr_ratio" class="badge bg-primary">R/R: ---</span>
                                    </div>
                                    <div class="row text-center g-2 mt-2">
                                        <div class="col-md-4">
                                            <div class="p-2 border border-secondary rounded-3">
                                                <div class="small text-secondary">نقطه ورود</div>
                                                <div id="summary_entry" class="h6 fw-bold mb-0">---</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-2 border border-secondary rounded-3">
                                                <div class="small text-secondary">حد ضرر (SL)</div>
                                                <div id="summary_sl" class="h6 fw-bold text-danger mb-0">---</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-2 border border-secondary rounded-3">
                                                <div class="small text-secondary">حد سود (TP)</div>
                                                <div id="summary_tp" class="h6 fw-bold text-success mb-0">---</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Smart AI-Like Analysis Text -->
                        <div class="mt-4 bg-light p-3 rounded-4 border">
                            <h6 class="fw-bold text-primary mb-2"><i class="fa-solid fa-robot me-1"></i> تحلیل هوشمند سیستم:</h6>
                            <div id="smart_analysis_text" class="small text-muted" style="line-height: 1.8; text-align: justify;">
                                در حال تحلیل داده‌ها...
                            </div>
                        </div>

                        <!-- ML Indicator Prioritization -->
                        <div id="ml_prio_container" class="mt-4 border-top pt-4">
                            <h6 class="fw-bold text-dark mb-3"><i class="fa-solid fa-ranking-star text-warning me-1"></i> اولویت‌بندی هوشمند اندیکاتورها (Machine Learning):</h6>
                            <div class="row g-3" id="ml_ranking_list">
                                <!-- Rankings will be injected here -->
                            </div>
                            <div class="small text-muted mt-2 mt-2" style="font-size: 0.75rem;">
                                * سیستم بر اساس رفتار تاریخی این سهم، اندیکاتورهایی که بیشترین دقت (Accuracy) را در پیش‌بینی حرکت قیمت داشته‌اند رتبه‌بندی کرده است.
                            </div>
                        </div>
                    </div>

                        <!-- Chart Container -->
                    <div id="chart_container" class="card p-4 mb-4" style="display: none;">
                        <h4 class="fw-bold mb-3 text-primary">نمودار تکنیکال و حجم (شمسی)</h4>
                        <div id="main_chart" style="min-height: 500px;"></div>
                        <div id="volume_chart" style="height: 250px; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px;"></div>
                    </div>

                    <!-- Indicator Charts Container -->
                    <div id="indicator_charts_container" class="row g-4 mb-4" style="display: none;">
                        <!-- Individual indicator charts will be injected here -->
                    </div>

                    <div class="card p-0 overflow-hidden">
                        <div class="d-flex justify-content-between align-items-center p-4 bg-white border-bottom">
                            <h4 id="result_title" class="fw-bold mb-0 text-primary">نتایج تحلیل</h4>
                            <div class="d-flex gap-2">
                                <button id="btn_copy" class="btn btn-outline-secondary btn-download">
                                    <i class="fa-solid fa-copy"></i> کپی
                                </button>
                                <button id="btn_image" class="btn btn-warning btn-download text-white">
                                    <i class="fa-solid fa-image"></i> دانلود عکس نمودار
                                </button>
                                <button id="btn_package" class="btn btn-primary btn-download">
                                    <i class="fa-solid fa-file-zipper"></i> دانلود پکیج کامل (دیتا + نمودار)
                                </button>
                                <button id="btn_excel" class="btn btn-success btn-download">
                                    <i class="fa-solid fa-file-excel"></i> Excel
                                </button>
                                <button id="btn_csv" class="btn btn-info btn-download text-white">
                                    <i class="fa-solid fa-file-csv"></i> CSV
                                </button>
                                <button id="btn_pdf" class="btn btn-danger btn-download">
                                    <i class="fa-solid fa-file-pdf"></i> PDF
                                </button>
                                <button id="btn_ai" class="btn btn-dark btn-download">
                                    <i class="fa-solid fa-microchip"></i> بسته داده AI (JSON)
                                </button>
                            </div>
                        </div>

                        <!-- Tabs for Daily/Weekly -->
                        <div id="tech_tabs_container" class="px-4 pt-3 bg-light border-bottom d-flex justify-content-between align-items-center" style="display: none;">
                            <ul class="nav nav-tabs border-0" id="techTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active fw-bold" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-pane" type="button" role="tab" onclick="switchTimeframe('daily')">تحلیل روزانه</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-bold" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly-pane" type="button" role="tab" onclick="switchTimeframe('weekly')">تحلیل هفتگی</button>
                                </li>
                            </ul>
                            <div class="ms-auto pb-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="timeframe" id="tf_daily" value="daily" checked onchange="switchTimeframe('daily')">
                                    <label class="btn btn-outline-primary" for="tf_daily">D</label>
                                    
                                    <input type="radio" class="btn-check" name="timeframe" id="tf_weekly" value="weekly" onchange="switchTimeframe('weekly')">
                                    <label class="btn btn-outline-primary" for="tf_weekly">W</label>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="techTabsContent">
                            <div class="tab-pane fade show active" id="daily-pane" role="tabpanel">
                                <div class="table-container">
                                    <table id="data_table" class="table table-striped table-hover">
                                        <thead id="table_head"></thead>
                                        <tbody id="table_body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="weekly-pane" role="tabpanel">
                                <div class="table-container">
                                    <table id="weekly_data_table" class="table table-striped table-hover">
                                        <thead id="weekly_table_head"></thead>
                                        <tbody id="weekly_table_body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // Initialize Jalali Datepicker
        const watchlistItems = document.getElementById('watchlist_items');
        const btnAddWatchlist = document.getElementById('btn_add_watchlist');
        jalaliDatepicker.startWatch({
            separatorChar: "-",
            minDate: "attr",
            maxDate: "attr"
        });

        const assetTypeSelect = document.getElementById('asset_type');
        const symbolSelect = document.getElementById('symbol');
        const symbolSearch = document.getElementById('symbol_search');
        const btnRefreshSymbols = document.getElementById('btn_refresh_symbols');
        const btnSyncRegistry = document.getElementById('btn_sync_registry');

        if (btnSyncRegistry) {
            btnSyncRegistry.addEventListener('click', async () => {
                const confirmMsg = "آیا مایل به بروزرسانی کامل دیتابیس نمادها هستید؟ این کار ممکن است چند دقیقه طول بکشد و از سهمیه درخواست‌های روزانه شما کسر کند.";
                if (!confirm(confirmMsg)) return;

                btnSyncRegistry.disabled = true;
                btnSyncRegistry.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> در حال همگام‌سازی...';
                
                try {
                    const response = await fetch('/api/sync_registry', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.status === 'completed') {
                        let successCount = 0;
                        let total = 0;
                        for (let k in result.details) {
                            if (result.details[k] === 'success') successCount++;
                            total++;
                        }
                        
                        showToast('پایان عملیات', `بروزرسانی کامل شد. (${successCount}/${total} بازار با موفقیت آپدیت شدند)`, 'success');
                    } else {
                        showToast('خطا', 'مشکلی در عملیات همگام‌سازی پیش آمد', 'danger');
                    }
                } catch (e) {
                    console.error(e);
                    showToast('خطای شبکه', 'عدم ارتباط با سرور محلی', 'danger');
                } finally {
                    btnSyncRegistry.disabled = false;
                    btnSyncRegistry.innerHTML = '<i class="fa-solid fa-cloud-arrow-down me-1"></i> بروزرسانی کل حافظه';
                }
            });
        }
        const serviceLinks = document.querySelectorAll('.nav-link[data-value]');
        const serviceDesc = document.getElementById('service_desc');
        const btnFetch = document.getElementById('btn_fetch');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result_container');
        const tableHead = document.getElementById('table_head');
        const themeToggle = document.getElementById('theme-toggle');

        // Theme Toggle Logic
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            setStorageItem('theme', newTheme);
        });

        // Load saved theme
        const savedTheme = getStorageItem('theme', 'light');
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';

        // Watchlist Logic
        // (Consolidated below in the script)

        const tableBody = document.getElementById('table_body');
        const weeklyTableHead = document.getElementById('weekly_table_head');
        const weeklyTableBody = document.getElementById('weekly_table_body');
        const codalCategoryContainer = document.getElementById('codal_category_container');
        const codalCategorySelect = document.getElementById('codal_category');

        let currentData = [];
        let currentWeeklyData = [];
        let allSymbols = [];
        let symbolBrowserCache = {}; // Local memory cache to prevent redundant fetches
        let activeService = 'technical';
        let currentTimeframe = 'daily';

        // Utility: Jalali Date Formatter
        const jalaliFormatter = (val) => {
            if (!val) return '---';
            const date = new Date(val);
            if (isNaN(date.getTime())) return val;
            return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }).format(date);
        };

        function switchTimeframe(tf) {
            currentTimeframe = tf;
            
            // Sync radio buttons
            const rb = document.getElementById(tf === 'weekly' ? 'tf_weekly' : 'tf_daily');
            if (rb) rb.checked = true;
            
            // Sync tabs
            const tabId = tf === 'weekly' ? 'weekly-tab' : 'daily-tab';
            const targetTab = document.getElementById(tabId);
            if (targetTab && !targetTab.classList.contains('active')) {
                const tab = new bootstrap.Tab(targetTab);
                tab.show();
            }

            // Update Summaries and Charts
            const dataToUse = tf === 'weekly' ? currentWeeklyData : currentData;
            if (dataToUse && dataToUse.length > 0) {
                updateTechSummary(dataToUse);
                renderCandlestickChart(dataToUse);
                renderIndicatorCharts(dataToUse);
            }
        }

        // Tab switching listeners
        document.getElementById('daily-tab')?.addEventListener('click', () => switchTimeframe('daily'));
        document.getElementById('weekly-tab')?.addEventListener('click', () => switchTimeframe('weekly'));



        function updateTechSummary(data) {
            if (!data || data.length === 0) return;
            
            const latest = data[0];
            const sigEl = document.getElementById('summary_signal');
            if (sigEl) {
                sigEl.textContent = latest.Signal || 'Neutral';
                sigEl.className = 'h4 fw-bold mb-0 ' + (latest.Signal?.includes('Bullish') ? 'text-success' : latest.Signal?.includes('Bearish') ? 'text-danger' : '');
            }
            
            const patternEl = document.getElementById('summary_pattern');
            if (patternEl) patternEl.textContent = latest.Pattern || '---';
            
            const rsiEl = document.getElementById('summary_rsi');
            if (rsiEl) rsiEl.textContent = latest.RSI || '---';
            
            const trendEl = document.getElementById('summary_trend');
            if (trendEl) {
                if (latest.SMA20 && latest.SMA50) {
                    trendEl.textContent = latest.SMA20 > latest.SMA50 ? 'صعودی' : 'نزولی';
                    trendEl.className = 'h4 fw-bold mb-0 ' + (latest.SMA20 > latest.SMA50 ? 'text-success' : 'text-danger');
                } else {
                    trendEl.textContent = '---';
                }
            }

            // Fibonacci
            const fibEl = document.getElementById('summary_fib');
            if (fibEl && latest.fibonacci) {
                fibEl.innerHTML = `<span class="text-primary">${latest.fibonacci['61.8%'].toLocaleString()} (61.8%)</span>`;
            }

            // Ichimoku
            const ichiEl = document.getElementById('summary_ichimoku');
            if (ichiEl) {
                let status = 'خنثی';
                if (latest.Ichimoku_Conv > latest.Ichimoku_Base) status = '<span class="text-success">صعودی</span>';
                else if (latest.Ichimoku_Conv < latest.Ichimoku_Base) status = '<span class="text-danger">نزولی</span>';
                ichiEl.innerHTML = status;
            }

            // Divergence
            const divEl = document.getElementById('summary_divergence');
            if (divEl) {
                divEl.innerHTML = latest.divergence === 'Bullish Divergence' ? '<span class="text-success">واگرایی مثبت</span>' : 
                                 latest.divergence === 'Bearish Divergence' ? '<span class="text-danger">واگرایی منفی</span>' : 'ندارد';
            }

            // Beta
            const betaEl = document.getElementById('summary_beta');
            if (betaEl) betaEl.textContent = latest.beta || '---';

            // Risk/Reward
            if (latest.risk_reward) {
                const rr = latest.risk_reward;
                document.getElementById('summary_rr_ratio').textContent = `R/R: ${rr.ratio}`;
                document.getElementById('summary_entry').textContent = rr.entry.toLocaleString();
                document.getElementById('summary_sl').textContent = rr.stop_loss.toLocaleString();
                document.getElementById('summary_tp').textContent = rr.take_profit.toLocaleString();
            }

            // Generate Smart Analysis Text
            let analysis = `بر اساس آخرین داده‌های دریافتی، نماد در وضعیت <b>${latest.Signal || 'خنثی'}</b> قرار دارد. `;
            if (latest.RSI < 30) analysis += "شاخص RSI نشان‌دهنده اشباع فروش است که می‌تواند فرصت خرید پله‌ای باشد. ";
            else if (latest.RSI > 70) analysis += "شاخص RSI در محدوده اشباع خرید قرار دارد، احتیاط در خرید توصیه می‌شود. ";
            
            if (latest.MACD > latest.MACD_Sig) analysis += "تقاطع مثبت در MACD تاییدکننده قدرت خریداران است. ";
            
            if (latest.divergence) analysis += `توجه: یک <b>${latest.divergence === 'Bullish Divergence' ? 'واگرایی مثبت' : 'واگرایی منفی'}</b> در اندیکاتور RSI مشاهده شد که نشانه بازگشت روند است. `;

            if (latest.risk_reward && latest.risk_reward.ratio > 2) {
                analysis += "با توجه به نسبت ریسک به ریوارد مناسب (بالای ۲)، ورود در این محدوده جذابیت فنی دارد. ";
            }
            
            if (latest.Ichimoku_Conv > latest.Ichimoku_Base) analysis += "همچنین خطوط ایچیموکو گارد صعودی به خود گرفته‌اند. ";

            const smartText = document.getElementById('smart_analysis_text');
            if (smartText) smartText.innerHTML = analysis;

            // Update S/R UI
            const resContainer = document.getElementById('summary_resistances');
            const supContainer = document.getElementById('summary_supports');
            
            if (resContainer && latest.resistances) {
                resContainer.innerHTML = latest.resistances.map(r => 
                    `<span class="badge bg-danger-soft text-danger border border-danger p-2">
                        ${r.value.toLocaleString()} <small>(قدرت: ${r.strength})</small>
                    </span>`
                ).join('');
            }
            if (supContainer && latest.supports) {
                supContainer.innerHTML = latest.supports.map(s => 
                    `<span class="badge bg-success-soft text-success border border-success p-2">
                        ${s.value.toLocaleString()} <small>(قدرت: ${s.strength})</small>
                    </span>`
                ).join('');
            }

            // Update ML Rankings
            const mlContainer = document.getElementById('ml_ranking_list');
            if (mlContainer && latest.recommended_indicators) {
                mlContainer.innerHTML = latest.recommended_indicators.slice(0, 4).map((ind, idx) => `
                    <div class="col-md-3">
                        <div class="p-3 border rounded-4 h-100 ${idx === 0 ? 'bg-primary-soft border-primary' : 'bg-white'}">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="badge ${idx === 0 ? 'bg-primary' : 'bg-secondary'}">رتبه ${idx + 1}</span>
                                <span class="fw-bold text-primary">${ind.accuracy}% دقت</span>
                            </div>
                            <h6 class="fw-bold mb-1">${ind.name}</h6>
                            <div class="text-muted" style="font-size: 0.75rem;">${ind.description}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function normalizePersian(text) {
            if (!text) return "";
            return text.toString()
                .replace(/ي/g, "ی")
                .replace(/ك/g, "ک")
                .replace(/‌/g, " ")
                .toLowerCase()
                .trim();
        }

        function updateServiceDesc() {
            const activeLink = document.querySelector('.nav-link.active[data-value]');
            if (activeLink) {
                serviceDesc.textContent = activeLink.dataset.desc || '';
                activeService = activeLink.dataset.value;
                codalCategoryContainer.style.display = (activeService === 'codal') ? 'block' : 'none';
                
                // Show timeframe only for technical analysis
                const timeframeFields = document.querySelector('[name="timeframe"]')?.closest('.col-lg-3');
                if (timeframeFields) {
                    timeframeFields.style.display = (activeService === 'technical') ? 'block' : 'none';
                }
            }
        }

        serviceLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (link.classList.contains('disabled')) return;
                
                const service = link.dataset.value;
                serviceLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                updateServiceDesc();
                
                // If switching to/from Codal, refresh symbol list to show/hide "All"
                if (allSymbols.length > 0) {
                    populateSymbolSelect(allSymbols);
                }

                if (service === 'technical' && !assetTypeSelect.value) {
                    alert('لطفاً ابتدا نوع بازار را انتخاب کنید.');
                }
            });
        });

        updateServiceDesc();

        function populateSymbolSelect(symbols) {
            symbolSelect.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = symbols.length > 0 ? `انتخاب نماد (${symbols.length} مورد)...` : 'نمادی یافت نشد';
            symbolSelect.appendChild(defaultOpt);

            // Add "All" option for Indices or Codal
            if (symbols.length > 0 && (assetTypeSelect.value.startsWith('indices') || activeService === 'codal')) {
                const allOpt = document.createElement('option');
                allOpt.value = 'all';
                allOpt.textContent = '--- همه موارد ---';
                symbolSelect.appendChild(allOpt);
            }

            const fragment = document.createDocumentFragment();
            symbols.forEach(s => {
                const opt = document.createElement('option');
                const val = s.l18 || s.id || s.isin || '';
                opt.value = val;
                opt.setAttribute('data-id', s.id || s.isin || val);
                opt.textContent = `${s.l18 || '---'} (${s.l30 || '---'})`;
                fragment.appendChild(opt);
            });
            symbolSelect.appendChild(fragment);
            symbolSelect.disabled = false;

            // Better auto-selection logic
            if (symbols.length > 0) {
                if (assetTypeSelect.value.includes('indices')) {
                    // Indices usually use "all"
                    for (let i = 0; i < symbolSelect.options.length; i++) {
                        if (symbolSelect.options[i].value === 'all') {
                            symbolSelect.selectedIndex = i;
                            break;
                        }
                    }
                } else if (symbols.length === 1 && symbolSearch.value.trim() !== '') {
                    // If search has only one exact match, select it
                    symbolSelect.selectedIndex = symbolSelect.options.length - 1;
                }
            }
        }

        symbolSearch.addEventListener('input', () => {
            const term = normalizePersian(symbolSearch.value);
            if (!term) { populateSymbolSelect(allSymbols); return; }
            const filtered = allSymbols.filter(s => 
                (s.l18 && normalizePersian(s.l18).includes(term)) || 
                (s.l30 && normalizePersian(s.l30).includes(term)) ||
                (s.isin && s.isin.toLowerCase().includes(term)) ||
                (s.id && s.id.toString().includes(term))
            );
            populateSymbolSelect(filtered);
        });

        symbolSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (symbolSelect.value) {
                    btnFetch.click();
                }
            }
        });

        const loadSymbols = async (refresh = false) => {
            const val = assetTypeSelect.value;
            if (!val) {
                symbolSelect.innerHTML = '<option value="">ابتدا بازار را انتخاب کنید</option>';
                symbolSelect.disabled = true;
                return;
            }

            // FAST-SWITCH: If already fetched this session, use it instantly
            if (!refresh && symbolBrowserCache[val]) {
                allSymbols = symbolBrowserCache[val];
                populateSymbolSelect(allSymbols);
                return;
            }

            symbolSelect.innerHTML = `<option value="">در حال بارگذاری نمادها${refresh ? ' (بروزرسانی)' : ''}...</option>`;
            symbolSelect.disabled = true;
            symbolSearch.disabled = true;
            btnFetch.disabled = true;
            symbolSearch.value = '';
            // Don't clear allSymbols immediately to keep the UI stable if possible

            if (val.includes('indices')) {
                serviceLinks.forEach(link => {
                    const allowed = ['realtime', 'technical', 'history'];
                    if (!allowed.includes(link.dataset.value)) {
                        link.classList.add('disabled');
                    } else {
                        link.classList.remove('disabled');
                    }
                });
                const activeLink = document.querySelector('#analysis_list .nav-link.active');
                if (activeLink && activeLink.classList.contains('disabled')) {
                    document.querySelector('#analysis_list .nav-link[data-value="technical"]').click();
                }
            } else {
                serviceLinks.forEach(link => link.classList.remove('disabled'));
            }
            updateServiceDesc();

            try {
                const response = await fetch(`/api/symbols/${val}${refresh ? '?refresh=true' : ''}`);
                const symbols = await response.json();
                if (symbols.error) {
                    symbolSelect.innerHTML = `<option value="">خطا: ${symbols.error}</option>`;
                    if (refresh) {
                        alert(`مشکل در بروزرسانی: ${symbols.error}`);
                    }
                } else {
                    allSymbols = symbols;
                    symbolBrowserCache[val] = symbols; // Save to session cache
                    populateSymbolSelect(allSymbols);
                    if (refresh) {
                        showToast('بروزرسانی موفقیت‌آمیز', 'لیست نمادها با موفقیت آپدیت شد', 'success');
                    }
                }
            } catch (e) {
                symbolSelect.innerHTML = `<option value="">خطا در ارتباط با سرور</option>`;
                console.error(e);
            } finally {
                btnFetch.disabled = false;
                symbolSelect.disabled = false;
                symbolSearch.disabled = false;
                btnRefreshSymbols.innerHTML = '<i class="fa-solid fa-rotate"></i>';
                btnRefreshSymbols.disabled = false;
            }
        };

        btnRefreshSymbols.addEventListener('click', () => loadSymbols(true));
        assetTypeSelect.addEventListener('change', () => loadSymbols(false));
        
        document.getElementById('btn_add_watchlist')?.addEventListener('click', addToWatchlist);

        btnFetch.addEventListener('click', async () => {
            const assetType = assetTypeSelect.value;
            const symbol = symbolSelect.value;
            let serviceType = activeService;
            const candleCount = document.getElementById('candle_count').value;

            let startDate = document.getElementById('start_date').value;
            let endDate = document.getElementById('end_date').value;
            const adjusted = document.getElementById('adjusted_prices').checked;
            const force_refresh = document.getElementById('force_refresh').checked;

            if (startDate) startDate = startDate.replace(/\//g, '-');
            if (endDate) endDate = endDate.replace(/\//g, '-');

            if (!assetType) {
                alert('لطفا ابتدا بازار را انتخاب کنید');
                return;
            }
            if (!symbol) {
                alert('لطفا یک نماد را انتخاب کنید یا جستجو نمایید');
                return;
            }

            loading.style.display = 'block';
            resultContainer.style.display = 'none';
            btnFetch.disabled = true;
            
            // Clear previous data
            currentData = [];
            currentWeeklyData = [];

            try {
                if (serviceType === 'technical') {
                    // Fetch both formats simultaneously for instant switching
                    const [dailyRes, weeklyRes] = await Promise.all([
                        fetch('/api/fetch_data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                asset_type: assetType, symbol, service_type: 'technical',
                                start_date: startDate, end_date: endDate, adjusted,
                                timeframe: 'daily', candle_count: candleCount,
                                refresh: force_refresh
                            })
                        }).then(r => r.json()),
                        fetch('/api/fetch_data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                asset_type: assetType, symbol, service_type: 'technical',
                                start_date: startDate, end_date: endDate, adjusted,
                                timeframe: 'weekly', candle_count: candleCount,
                                refresh: force_refresh
                            })
                        }).then(r => r.json())
                    ]);

                    if (dailyRes.error || weeklyRes.error) {
                        alert('خطا: ' + (dailyRes.error || weeklyRes.error));
                    } else {
                        currentData = dailyRes;
                        currentWeeklyData = weeklyRes;
                        
                        // Default to daily for the table render but respect current toggle for the view
                        renderTable(currentData, currentWeeklyData);
                        switchTimeframe(currentTimeframe);
                    }
                } else {
                    const response = await fetch('/api/fetch_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            asset_type: assetType,
                            symbol,
                            service_type: serviceType,
                            start_date: startDate,
                            end_date: endDate,
                            adjusted: adjusted,
                            candle_count: candleCount,
                            codal_category: codalCategorySelect.value,
                            refresh: force_refresh
                        })
                    });
                    currentData = await response.json();
                    if (currentData.error) {
                        alert('خطا: ' + currentData.error);
                    } else {
                        renderTable(currentData);
                    }
                }
                updateMarketStatus();
            } catch (e) {
                alert('خطا در دریافت داده');
            } finally {
                loading.style.display = 'none';
                btnFetch.disabled = false;
            }
        });

        function renderTable(data, weeklyData = null) {
            if (!data || data.length === 0) { 
                alert('داده‌ای یافت نشد. ممکن است برای این نماد در بازه زمانی انتخاب شده داده‌ای وجود نداشته باشد.'); 
                return; 
            }

            resultContainer.style.display = 'block';
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            weeklyTableHead.innerHTML = '';
            weeklyTableBody.innerHTML = '';

            // Handle Technical Analysis (Summary + Chart)
            const techSummary = document.getElementById('tech_summary_container');
            const chartContainer = document.getElementById('chart_container');
            const indicatorChartsContainer = document.getElementById('indicator_charts_container');
            const techTabs = document.getElementById('tech_tabs_container');
            
            if (activeService === 'technical' && data.length > 0) {
                techSummary.style.display = 'block';
                chartContainer.style.display = 'block';
                indicatorChartsContainer.style.display = 'flex';
                techTabs.style.display = 'flex'; // Use flex for alignment
                
                // switchTimeframe is called after renderTable in the click handler
            } else {
                techSummary.style.display = 'none';
                chartContainer.style.display = 'none';
                indicatorChartsContainer.style.display = 'none';
                techTabs.style.display = 'none';
                
                if (activeService === 'client_type') {
                    renderClientTypeChart(data);
                } else if (activeService === 'transactions') {
                    renderTransactionChart(data);
                } else if (activeService === 'shareholders') {
                    renderShareholderChart(data);
                }
            }

            const persianKeys = {
                'l18': 'نماد', 'l30': 'نام کامل', 'pc': 'پایانی', 'pcc': 'تغییر', 'pcp': 'درصد',
                'pl': 'آخرین', 'plc': 'تغییر ل.', 'plp': 'درصد ل.', 'pf': 'اولین', 'py': 'دیروز',
                'pmin': 'کمترین', 'pmax': 'بیشترین', 'tno': 'تعداد', 'tvol': 'حجم', 'tval': 'ارزش',
                'time': 'زمان/تاریخ', 'date': 'تاریخ', 'eps': 'EPS', 'pe': 'P/E', 'bvol': 'حجم مبنا',
                'mv': 'ارزش بازار', 'z': 'تعداد سهام', 'isin': 'ISIN', 'cs': 'گروه', 'nav': 'NAV',
                'count': 'تعداد نماد', 'open': 'بازگشایی', 'high': 'بیشترین', 'low': 'کمترین',
                'close': 'پایانی', 'volume': 'حجم', 'SMA20': 'SMA20', 'SMA50': 'SMA50',
                'EMA20': 'EMA20', 'EMA50': 'EMA50', 'MACD': 'MACD', 'MACD_Sig': 'Signal',
                'ADX': 'ADX', 'RSI': 'RSI', 'STOCHk': 'StochK', 'STOCHd': 'StochD',
                'WILLR': 'WillR', 'ROC': 'ROC', 'MFI': 'MFI', 'BBU': 'BB Up', 'BBL': 'BB Low',
                'ATR': 'ATR', 'STDDEV': 'StdDev', 'KC_Upper': 'Keltner', 'DC_Upper': 'Donchian',
                'title': 'عنوان اطلاعیه', 'code': 'کد', 'date_publish': 'انتشار', 'link': 'لینک',
                'link_pdf': 'PDF', 'link_excel': 'Excel', 'link_attachment': 'پیوست',
                'Signal': 'سیگنال', 'Pattern': 'الگو'
            };

            const fillTable = (targetData, headEl, bodyEl) => {
                if (!targetData || targetData.length === 0) return;
                let keys = Object.keys(targetData[0]);
                if (activeService === 'technical') {
                    const priority = ['date', 'Signal', 'Pattern', 'close', 'RSI', 'MACD', 'SMA20', 'SMA50'];
                    keys = [
                        ...priority.filter(k => keys.includes(k)),
                        ...keys.filter(k => !priority.includes(k) && !['open', 'high', 'low', 'volume'].includes(k)),
                        ...['open', 'high', 'low', 'volume'].filter(k => keys.includes(k))
                    ];
                }

                const trHead = document.createElement('tr');
                keys.forEach(k => {
                    const th = document.createElement('th');
                    th.textContent = persianKeys[k] || k;
                    trHead.appendChild(th);
                });
                headEl.appendChild(trHead);

                targetData.forEach(row => {
                    const tr = document.createElement('tr');
                    keys.forEach(k => {
                        const td = document.createElement('td');
                        let val = row[k];
                        if (['pcp', 'plp', 'pcc', 'plc', 'index_change_percent', 'change_percent'].includes(k)) {
                            const num = parseFloat(val);
                            if (num > 0) td.className = 'text-up';
                            else if (num < 0) td.className = 'text-down';
                        }
                        if (k === 'Signal' && val) {
                            if (val.includes('Bullish')) td.className = 'signal-bullish';
                            else if (val.includes('Bearish')) td.className = 'signal-bearish';
                            else if (val.includes('Oversold')) td.className = 'signal-oversold';
                            else if (val.includes('Overbought')) td.className = 'signal-overbought';
                        }
                        if (k === 'Pattern' && val && val !== '---') td.className = 'fw-bold text-primary';
                        if (k.startsWith('link') && val && val.startsWith('http')) {
                            td.innerHTML = `<a href="${val}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2">مشاهده</a>`;
                        } else {
                            if (typeof val === 'number' && !['eps', 'pe', 'pcp', 'plp'].includes(k)) val = val.toLocaleString();
                            td.textContent = val || '---';
                        }
                        tr.appendChild(td);
                    });
                    bodyEl.appendChild(tr);
                });
            };

            fillTable(data, tableHead, tableBody);
            if (weeklyData) {
                fillTable(weeklyData, weeklyTableHead, weeklyTableBody);
            }

            // Check Alerts for the latest price
            if (data.length > 0 && data[0].l18) {
                const latest = data[0];
                checkAlerts(latest.l18, latest.pl || latest.pc);
            }
        }

        // --- Watchlist Logic ---
        function getStorageItem(key, defaultVal) {
            try {
                return localStorage.getItem(key) || defaultVal;
            } catch (e) {
                console.warn('Storage access blocked:', e);
                return defaultVal;
            }
        }
        
        function setStorageItem(key, val) {
            try {
                localStorage.setItem(key, val);
            } catch (e) {
                console.warn('Storage access blocked:', e);
            }
        }

        let watchlist = JSON.parse(getStorageItem('tse_watchlist', '[]'));
        
        function addToWatchlist() {
            const symbol = symbolSelect.value;
            if (!symbol || watchlist.includes(symbol)) return;
            watchlist.push(symbol);
            setStorageItem('tse_watchlist', JSON.stringify(watchlist));
            renderWatchlist();
        }

        window.removeFromWatchlist = function(symbol) {
            watchlist = watchlist.filter(s => s !== symbol);
            setStorageItem('tse_watchlist', JSON.stringify(watchlist));
            renderWatchlist();
        };

        function renderWatchlist() {
            const container = document.getElementById('watchlist_items');
            if (!container) return;
            container.innerHTML = watchlist.map(s => `
                <div class="watchlist-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="pointer" onclick="loadFromWatchlist('${s}')">${s}</span>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="removeFromWatchlist('${s}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        window.loadFromWatchlist = function(symbol) {
            symbolSearch.value = symbol;
            symbolSearch.dispatchEvent(new Event('input'));
            setTimeout(() => {
                for (let i = 0; i < symbolSelect.options.length; i++) {
                    if (symbolSelect.options[i].value === symbol) {
                        symbolSelect.selectedIndex = i;
                        btnFetch.click();
                        return;
                    }
                }
                if (symbolSelect.options.length > 1) {
                    symbolSelect.selectedIndex = symbolSelect.options.length - 1;
                    btnFetch.click();
                }
            }, 500);
        };

        if (btnAddWatchlist) btnAddWatchlist.addEventListener('click', addToWatchlist);

        // --- Charting Logic ---
        let mainChart = null;
        let volumeChart = null;
        let indicatorCharts = [];

        function renderCandlestickChart(data) {
            const container = document.getElementById('main_chart');
            const volContainer = document.getElementById('volume_chart');
            
            // Check if professional backend chart exists
            if (data[0] && data[0].chart_image) {
                container.innerHTML = `<img src="data:image/png;base64,${data[0].chart_image}" class="img-fluid rounded-4 shadow-sm" style="width:100%">`;
                volContainer.style.display = 'none';
                return;
            }
            
            volContainer.style.display = 'block';
            container.innerHTML = '';
            volContainer.innerHTML = '';
            
            const sortedData = [...data].reverse();
            const chartData = sortedData.map(item => ({
                x: new Date(item.date || item.time).getTime(),
                y: [
                    parseFloat(item.open || item.pf || item.pc),
                    parseFloat(item.high || item.pmax || item.pc),
                    parseFloat(item.low || item.pmin || item.pc),
                    parseFloat(item.close || item.pc)
                ]
            }));

            const volumeData = sortedData.map(item => {
                const open = parseFloat(item.open || item.pf || item.pc || 0);
                const close = parseFloat(item.close || item.pc || 0);
                return {
                    x: new Date(item.date || item.time).getTime(),
                    y: parseFloat(item.volume || item.tvol || 0),
                    fillColor: close >= open ? '#22c55e' : '#ef4444',
                    strokeColor: close >= open ? '#22c55e' : '#ef4444'
                };
            });

            const options = {
                series: [{ name: 'قیمت', data: chartData }],
                chart: { 
                    type: 'candlestick', 
                    height: 450, 
                    id: 'price-chart', 
                    group: 'stock', 
                    toolbar: { show: true }, 
                    fontFamily: 'Vazirmatn',
                    animations: { enabled: false }
                },
                xaxis: { 
                    type: 'datetime', 
                    labels: { 
                        formatter: jalaliFormatter,
                        style: { fontSize: '11px' },
                        hideOverlappingLabels: true,
                        rotate: -45,
                        rotateAlways: false
                    },
                    tooltip: { enabled: true },
                    axisBorder: { show: true, color: '#e0e0e0' }
                },
                yaxis: { 
                    labels: { 
                        formatter: (val) => val.toLocaleString(),
                        offsetY: 0
                    },
                    opposite: true
                },
                plotOptions: { 
                    candlestick: { 
                        colors: { upward: '#22c55e', downward: '#ef4444' },
                        wick: { useFillColor: true }
                    } 
                },
                tooltip: { 
                    shared: true,
                    custom: [
                        function({ seriesIndex, dataPointIndex, w }) {
                            const o = w.globals.seriesCandleO[seriesIndex][dataPointIndex];
                            const h = w.globals.seriesCandleH[seriesIndex][dataPointIndex];
                            const l = w.globals.seriesCandleL[seriesIndex][dataPointIndex];
                            const c = w.globals.seriesCandleC[seriesIndex][dataPointIndex];
                            const timestamp = w.globals.seriesX[seriesIndex][dataPointIndex];
                            const dateStr = jalaliFormatter(timestamp);
                            
                            return (
                                '<div class="p-2 border-0 bg-white text-dark shadow-sm rounded-3">' +
                                '<div class="text-muted border-bottom mb-1 pb-1 text-center font-monospace">' + dateStr + '</div>' +
                                '<div>باز: <b>' + o.toLocaleString() + '</b></div>' +
                                '<div>بیشترین: <b>' + h.toLocaleString() + '</b></div>' +
                                '<div>کمترین: <b>' + l.toLocaleString() + '</b></div>' +
                                '<div>بسته: <b>' + c.toLocaleString() + '</b></div>' +
                                '</div>'
                            );
                        }
                    ]
                }
            };

            const volOptions = {
                series: [{ name: 'حجم', data: volumeData }],
                chart: { 
                    type: 'bar', 
                    height: 180, 
                    id: 'vol-chart', 
                    group: 'stock', 
                    toolbar: { show: false }, 
                    fontFamily: 'Vazirmatn',
                    animations: { enabled: false }
                },
                xaxis: { 
                    type: 'datetime', 
                    labels: { 
                        formatter: jalaliFormatter,
                        style: { fontSize: '11px' },
                        hideOverlappingLabels: true,
                        rotate: -45
                    },
                    axisBorder: { show: true, color: '#e0e0e0' }
                },
                yaxis: { 
                    labels: { 
                        formatter: (val) => {
                            if (val >= 1000000000) return (val/1000000000).toFixed(1) + 'B';
                            if (val >= 1000000) return (val/1000000).toFixed(1) + 'M';
                            if (val >= 1000) return (val/1000).toFixed(1) + 'K';
                            return val;
                        }
                    },
                    opposite: true
                },
                dataLabels: { enabled: false },
                plotOptions: {
                    bar: {
                        columnWidth: '80%',
                        distributed: false // Use individual colors from data
                    }
                },
                tooltip: { x: { formatter: jalaliFormatter } }
            };

            if (mainChart) mainChart.destroy();
            if (volumeChart) volumeChart.destroy();
            mainChart = new ApexCharts(container, options);
            volumeChart = new ApexCharts(volContainer, volOptions);
            mainChart.render();
            volumeChart.render();
        }

        function renderIndicatorCharts(data) {
            const container = document.getElementById('indicator_charts_container');
            container.innerHTML = '';
            indicatorCharts.forEach(c => c.destroy());
            indicatorCharts = [];

            const baseKeys = ['date', 'time', 'open', 'high', 'low', 'close', 'volume', 'l18', 'l30', 'isin', 'cs', 'cs_id', 'eps', 'pe', 'pc', 'pcc', 'pcp', 'pmin', 'pmax', 'count', 'Signal', 'Pattern'];
            const indicatorKeys = Object.keys(data[0]).filter(k => !baseKeys.includes(k) && typeof data[0][k] === 'number');
            
            const sortedData = [...data].reverse();

            // Define important levels for indicators
            const levelsMap = {
                'RSI': [
                    { y: 30, color: '#22c55e', label: 'اشباع فروش' },
                    { y: 70, color: '#ef4444', label: 'اشباع خرید' }
                ],
                'MACD': [{ y: 0, color: '#94a3b8', label: 'خط صفر' }],
                'STOCHk': [{ y: 20, color: '#22c55e' }, { y: 80, color: '#ef4444' }],
                'STOCHd': [{ y: 20, color: '#22c55e' }, { y: 80, color: '#ef4444' }],
                'WILLR': [{ y: -80, color: '#22c55e' }, { y: -20, color: '#ef4444' }],
                'MFI': [{ y: 20, color: '#22c55e' }, { y: 80, color: '#ef4444' }],
                'ROC': [{ y: 0, color: '#94a3b8' }],
                'ADX': [{ y: 25, color: '#f59e0b', label: 'شروع روند' }]
            };

            indicatorKeys.forEach(key => {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `<div class="card p-3"><h6 class="fw-bold mb-2">${key}</h6><div id="chart_${key}" style="height: 250px;"></div></div>`;
                container.appendChild(col);

                const annotations = [];
                if (levelsMap[key]) {
                    levelsMap[key].forEach(level => {
                        annotations.push({
                            y: level.y,
                            borderColor: level.color,
                            strokeDashArray: 4,
                            label: {
                                borderColor: level.color,
                                style: { color: '#fff', background: level.color, fontSize: '10px' },
                                text: level.label || ''
                            }
                        });
                    });
                }

                const options = {
                    series: [{ name: key, data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: d[key] })) }],
                    chart: { type: 'line', height: 250, toolbar: { show: false }, animations: { enabled: false }, fontFamily: 'Vazirmatn' },
                    stroke: { width: 2, curve: 'smooth' },
                    xaxis: { 
                        type: 'datetime', 
                        labels: { 
                            show: true,
                            formatter: jalaliFormatter,
                            style: { fontSize: '9px' }
                        } 
                    },
                    yaxis: { labels: { show: true, style: { fontSize: '10px' } } },
                    colors: ['#2563eb'],
                    annotations: {
                        yaxis: annotations
                    }
                };

                const chart = new ApexCharts(document.getElementById(`chart_${key}`), options);
                chart.render();
                indicatorCharts.push(chart);
            });
        }

        let clientTypeChart = null;
        function renderClientTypeChart(data) {
            const container = document.getElementById('indicator_charts_container');
            // We use the indicator container but clear it first
            container.innerHTML = '<div class="col-12"><div class="card p-3"><h5 class="fw-bold mb-3">نمودار خرید و فروش حقیقی و حقوقی</h5><div id="client_chart" style="height: 400px;"></div></div></div>';
            container.style.display = 'flex';

            const sortedData = [...data].reverse();
            const options = {
                series: [
                    { name: 'خرید حقیقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: d.ct_buy_real_vol || 0 })) },
                    { name: 'فروش حقیقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: -(d.ct_sell_real_vol || 0) })) },
                    { name: 'خرید حقوقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: d.ct_buy_legal_vol || 0 })) },
                    { name: 'فروش حقوقی', data: sortedData.map(d => ({ x: new Date(d.date || d.time).getTime(), y: -(d.ct_sell_legal_vol || 0) })) }
                ],
                chart: { type: 'bar', height: 400, stacked: true, toolbar: { show: true }, fontFamily: 'Vazirmatn' },
                colors: ['#22c55e', '#ef4444', '#3b82f6', '#f59e0b'],
                xaxis: { 
                    type: 'datetime',
                    labels: { formatter: jalaliFormatter }
                },
                yaxis: { labels: { formatter: (val) => Math.abs(val).toLocaleString() } },
                plotOptions: { bar: { horizontal: false, columnWidth: '80%' } },
                dataLabels: { enabled: false }
            };

            if (clientTypeChart) clientTypeChart.destroy();
            clientTypeChart = new ApexCharts(document.getElementById('client_chart'), options);
            clientTypeChart.render();
        }

        let transactionChart = null;
        function renderTransactionChart(data) {
            const container = document.getElementById('indicator_charts_container');
            container.innerHTML = '<div class="col-12"><div class="card p-3"><h5 class="fw-bold mb-3">نمودار ریزمعاملات امروز</h5><div id="trans_chart" style="height: 400px;"></div></div></div>';
            container.style.display = 'flex';

            const sortedData = [...data].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            const options = {
                series: [{ name: 'قیمت معامله', data: sortedData.map(d => ({ x: d.time, y: parseFloat(d.p || 0) })) }],
                chart: { type: 'line', height: 400, toolbar: { show: true }, fontFamily: 'Vazirmatn' },
                stroke: { width: 2, curve: 'stepline' },
                xaxis: { 
                    title: { text: 'زمان' },
                    labels: { style: { fontFamily: 'Vazirmatn' } }
                },
                yaxis: { labels: { formatter: (val) => val.toLocaleString() } },
                colors: ['#2563eb']
            };

            if (transactionChart) transactionChart.destroy();
            transactionChart = new ApexCharts(document.getElementById('trans_chart'), options);
            transactionChart.render();
        }

        let shareholderChart = null;
        function renderShareholderChart(data) {
            const container = document.getElementById('indicator_charts_container');
            container.innerHTML = '<div class="col-12"><div class="card p-3"><h5 class="fw-bold mb-3">ترکیب سهامداران عمده</h5><div id="share_chart" style="height: 400px;"></div></div></div>';
            container.style.display = 'flex';

            const options = {
                series: data.map(d => parseFloat(d.per || 0)),
                labels: data.map(d => d.shareholder || 'سایر'),
                chart: { type: 'pie', height: 400, fontFamily: 'Vazirmatn' },
                legend: { position: 'bottom' },
                dataLabels: { formatter: (val) => val.toFixed(1) + '%' }
            };

            if (shareholderChart) shareholderChart.destroy();
            shareholderChart = new ApexCharts(document.getElementById('share_chart'), options);
            shareholderChart.render();
        }

        // --- Price Alerts Logic ---
        let alerts = JSON.parse(getStorageItem('tse_alerts', '[]'));
        
        function addAlert() {
            const symbolSelect = document.getElementById('symbol');
            const symbol = symbolSelect?.value || '';
            const price = parseFloat(document.getElementById('alert_price')?.value);
            const type = document.getElementById('alert_type')?.value;

            if (!symbol || isNaN(price)) {
                alert('لطفا ابتدا یک نماد انتخاب کرده و قیمت هدف را وارد کنید');
                return;
            }

            alerts.push({ id: Date.now(), symbol, price, type, active: true });
            setStorageItem('tse_alerts', JSON.stringify(alerts));
            renderAlerts();
            const priceInput = document.getElementById('alert_price');
            if (priceInput) priceInput.value = '';
        }

        function removeAlert(id) {
            alerts = alerts.filter(a => a.id !== id);
            setStorageItem('tse_alerts', JSON.stringify(alerts));
            renderAlerts();
        }

        function renderAlerts() {
            const list = document.getElementById('alerts_list');
            if (!list) return;

            list.innerHTML = alerts.map(a => `
                <div class="watchlist-item d-flex justify-content-between align-items-center mb-2 p-1 border rounded bg-light" style="font-size: 0.75rem;">
                    <div>
                        <strong class="text-primary">${a.symbol}</strong> ${a.type === 'above' ? '↑' : '↓'} ${a.price.toLocaleString()}
                    </div>
                    <button class="btn btn-sm text-danger p-0 border-0" onclick="removeAlert(${a.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function checkAlerts(currentSymbol, currentPrice) {
            alerts.forEach(a => {
                if (a.active && a.symbol === currentSymbol) {
                    let triggered = false;
                    if (a.type === 'above' && currentPrice >= a.price) triggered = true;
                    if (a.type === 'below' && currentPrice <= a.price) triggered = true;

                    if (triggered) {
                        if (Notification.permission === "granted") {
                            new Notification(`هشدار قیمت: ${a.symbol}`, { body: `قیمت به ${currentPrice.toLocaleString()} رسید.` });
                        } else {
                            alert(`🔔 هشدار قیمت: ${a.symbol} به ${currentPrice.toLocaleString()} رسید!`);
                        }
                        a.active = false;
                        setStorageItem('tse_alerts', JSON.stringify(alerts));
                        renderAlerts();
                    }
                }
            });
        }

        if (Notification.permission !== "denied") Notification.requestPermission();

        // --- Symbol Comparison Logic ---
        let compareList = [];
        function addToCompare() {
            const symbol = symbolSelect.value;
            if (!symbol || compareList.includes(symbol)) return;
            if (compareList.length >= 3) { alert('حداکثر ۳ نماد برای مقایسه'); return; }
            compareList.push(symbol);
            updateCompareUI();
        }

        function updateCompareUI() {
            const container = document.getElementById('compare_tags');
            container.innerHTML = compareList.map(s => `
                <span class="badge bg-info me-1">
                    ${s} <i class="fas fa-times ms-1 pointer" onclick="removeFromCompare('${s}')"></i>
                </span>
            `).join('');
        }

        function removeFromCompare(symbol) {
            compareList = compareList.filter(s => s !== symbol);
            updateCompareUI();
        }

        async function runComparison() {
            if (compareList.length < 2) { alert('حداقل ۲ نماد برای مقایسه انتخاب کنید'); return; }
            const resultsDiv = document.getElementById('comparison_results');
            resultsDiv.innerHTML = '<div class="spinner-border text-primary"></div>';
            try {
                const promises = compareList.map(s => fetch('/api/fetch_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asset_type: assetTypeSelect.value, symbol: s, service_type: 'realtime' })
                }).then(r => r.json()));
                const datasets = await Promise.all(promises);
                
                let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>فاکتور</th>';
                compareList.forEach(s => html += `<th>${s}</th>`);
                html += '</tr></thead><tbody>';

                const factors = [
                    { label: 'آخرین قیمت', key: 'pl' },
                    { label: 'تغییر قیمت', key: 'pcp', suffix: '%' },
                    { label: 'RSI (14)', key: 'RSI' },
                    { label: 'حجم معاملات', key: 'tvol' }
                ];

                factors.forEach(f => {
                    html += `<tr><td>${f.label}</td>`;
                    datasets.forEach(d => {
                        const val = d[0] ? d[0][f.key] : 'N/A';
                        html += `<td>${val}${f.suffix || ''}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
            } catch (e) { resultsDiv.innerHTML = '<div class="alert alert-danger">خطا در مقایسه نمادها</div>'; }
        }

        // --- Market Status & Time ---
        async function updateMarketStatus() {
            try {
                const response = await fetch('/api/market_status');
                const data = await response.json();
                const badge = document.getElementById('market_status_badge');
                badge.innerHTML = `<i class="fa-solid fa-circle fa-fade me-1"></i> بازار: ${data.status}`;
                document.getElementById('current_time').textContent = data.time;
                
                if (data.stats) {
                    document.getElementById('stat_total').textContent = data.stats.global.total;
                    document.getElementById('stat_blocked').textContent = data.stats.global.blocked;
                    document.getElementById('api_stats').classList.remove('d-none');
                    
                    // Update modal table
                    const tableBody = document.getElementById('stats_table_body');
                    if (tableBody) {
                        tableBody.innerHTML = '';
                        for (const [svc, s] of Object.entries(data.stats.services)) {
                            const successRate = s.total > 0 ? Math.round((s.success / s.total) * 100) : 0;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${svc}</td>
                                <td>${s.total}</td>
                                <td class="text-success">${s.success}</td>
                                <td class="text-danger">${s.blocked}</td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" style="width: ${successRate}%"></div>
                                    </div>
                                    <small>${successRate}%</small>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        }
                    }

                    // Update tooltip with per-service details
                    let details = 'جزئیات سرویس‌ها:\n';
                    for (const [svc, s] of Object.entries(data.stats.services)) {
                        details += `${svc}: ${s.success}/${s.total} (مسدود: ${s.blocked})\n`;
                    }
                    document.getElementById('api_stats').title = details;
                }
            } catch (e) {}
        }
        // setInterval(updateMarketStatus, 10000); // Removed as per user request: No automatic requests
        updateMarketStatus();

        // Initialize
        renderWatchlist();
        renderAlerts();
        
        // Add Clock/Date Logic
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }).format(now);
            
            const timeEl = document.getElementById('current_time');
            if (timeEl) {
                timeEl.innerText = timeStr;
                const dateEl = timeEl.nextElementSibling;
                if (dateEl) dateEl.innerText = dateStr;
            }
        }
        setInterval(updateClock, 1000);
        updateClock();

        function getFilename() {
            const symbol = symbolSelect.value || 'Export';
            const today = new Date().toISOString().split('T')[0];
            return `TSETMC-${symbol}-${today}`;
        }

        async function downloadFile(format) {
            if (!currentData || currentData.length === 0) {
                alert('ابتدا داده‌ها را دریافت کنید');
                return;
            }

            const btnId = format === 'excel' ? 'btn_excel' : (format === 'csv' ? 'btn_csv' : 'btn_image');
            const btn = document.getElementById(btnId);
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const filename = getFilename();
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        daily_data: currentData, 
                        weekly_data: currentWeeklyData,
                        format: format, 
                        filename: filename,
                        symbol: symbolSelect.value
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    let ext = '';
                    if (format === 'excel') ext = 'xlsx';
                    else if (format === 'image') ext = 'png';
                    else ext = (currentWeeklyData && currentWeeklyData.length > 0 ? 'zip' : 'csv');
                    
                    saveAs(blob, `${filename}.${ext}`);
                } else {
                    const err = await response.text();
                    alert('خطا در دانلود: ' + err);
                }
            } catch (e) {
                console.error(e);
                alert('خطا در ارتباط با سرور');
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        document.getElementById('btn_copy').addEventListener('click', () => {
            if (!currentData || currentData.length === 0) {
                alert('ابتدا داده‌ها را دریافت کنید');
                return;
            }
            const text = currentData.map(row => Object.values(row).join('\t')).join('\n');
            navigator.clipboard.writeText(text).then(() => alert('داده‌ها در حافظه کپی شد'));
        });

        document.getElementById('btn_excel').addEventListener('click', () => downloadFile('excel'));
        document.getElementById('btn_csv').addEventListener('click', () => downloadFile('csv'));
        document.getElementById('btn_image').addEventListener('click', () => downloadFile('image'));

        document.getElementById('btn_ai').addEventListener('click', async () => {
            if (!currentData || currentData.length === 0) {
                alert('ابتدا داده‌ها را دریافت کنید');
                return;
            }
            const btn = document.getElementById('btn_ai');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> در حال بسته‌بندی...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/ai_package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: symbolSelect.value, 
                        data: currentData,
                        weekly_data: currentWeeklyData
                    })
                });
                const result = await response.json();
                
                if (result.json && result.markdown) {
                    const zip = new JSZip();
                    const folder = zip.folder("AI_Data_Package");
                    
                    // 1. JSON Data
                    folder.file("data.json", JSON.stringify(result.json, null, 2));
                    
                    // 2. Markdown Report
                    folder.file("report.md", result.markdown);
                    
                    // 3. CSV Data
                    const sortedDaily = [...result.json.daily].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                    const wsDaily = XLSX.utils.json_to_sheet(sortedDaily);
                    folder.file("daily_data.csv", "\ufeff" + XLSX.utils.sheet_to_csv(wsDaily));
                    
                    if (result.json.weekly && result.json.weekly.length > 0) {
                        const sortedWeekly = [...result.json.weekly].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                        const wsWeekly = XLSX.utils.json_to_sheet(sortedWeekly);
                        folder.file("weekly_data.csv", "\ufeff" + XLSX.utils.sheet_to_csv(wsWeekly));
                    }

                    // 4. Chart Image
                    if (result.chart_image) {
                        folder.file("technical_chart.png", result.chart_image, { base64: true });
                    }

                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `${result.filename}.zip`);
                    
                    alert('بسته جامع داده‌های AI (شامل JSON، CSV و گزارش Markdown) دانلود شد. این فایل ZIP را می‌توانید در ChatGPT یا Claude آپلود کنید.');
                } else {
                    alert('خطا در تولید بسته داده');
                }
            } catch (e) {
                console.error(e);
                alert('خطا در ارتباط با سرور');
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });

        document.getElementById('btn_pdf').addEventListener('click', async () => {
            if (!currentData || currentData.length === 0) {
                alert('ابتدا داده‌ها را دریافت کنید');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const symbol = symbolSelect.value || 'Export';
            
            const btn = document.getElementById('btn_pdf');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> در حال تولید PDF...';

            try {
                const canvas = await html2canvas(document.getElementById('result_container'));
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                const filename = getFilename();
                doc.save(`${filename}.pdf`);
            } catch (e) {
                console.error(e);
                alert('خطا در تولید PDF');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });

        document.getElementById('btn_package').addEventListener('click', async () => {
            if (!currentData || currentData.length === 0) {
                alert('ابتدا داده‌ها را دریافت کنید');
                return;
            }

            const btn = document.getElementById('btn_package');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> در حال تولید پکیج...';
            btn.disabled = true;

            try {
                const zip = new JSZip();
                const symbol = symbolSelect.value || 'Export';
                const today = new Date().toISOString().split('T')[0];
                
                // 1. Daily Data
                const sortedDaily = [...currentData].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                const wsDaily = XLSX.utils.json_to_sheet(sortedDaily);
                const wbDaily = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wbDaily, wsDaily, "Daily");
                const excelDaily = XLSX.write(wbDaily, { bookType: 'xlsx', type: 'array' });
                zip.file(`${symbol}_Daily.xlsx`, excelDaily);
                zip.file(`${symbol}_Daily.csv`, "\ufeff" + XLSX.utils.sheet_to_csv(wsDaily));

                // 2. Weekly Data (if exists)
                if (currentWeeklyData && currentWeeklyData.length > 0) {
                    const sortedWeekly = [...currentWeeklyData].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                    const wsWeekly = XLSX.utils.json_to_sheet(sortedWeekly);
                    const wbWeekly = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wbWeekly, wsWeekly, "Weekly");
                    const excelWeekly = XLSX.write(wbWeekly, { bookType: 'xlsx', type: 'array' });
                    zip.file(`${symbol}_Weekly.xlsx`, excelWeekly);
                    zip.file(`${symbol}_Weekly.csv`, "\ufeff" + XLSX.utils.sheet_to_csv(wsWeekly));
                }

                // 3. Charts
                const chartsFolder = zip.folder("Charts");
                
                // Helper to render and capture
                const captureChart = async (options, id) => {
                    const el = document.getElementById(id);
                    if (!el) {
                        const newEl = document.createElement('div');
                        newEl.id = id;
                        newEl.style.position = 'absolute';
                        newEl.style.left = '-9999px';
                        document.body.appendChild(newEl);
                    }
                    const targetEl = document.getElementById(id);
                    targetEl.innerHTML = '';
                    const chart = new ApexCharts(targetEl, options);
                    await chart.render();
                    await new Promise(r => setTimeout(r, 1200)); // Wait for animations
                    const result = await chart.dataURI();
                    const uri = result.imgURI || result.dataUri || result;
                    chart.destroy();
                    if (typeof uri === 'string' && uri.includes(',')) {
                        return uri.split(',')[1];
                    }
                    throw new Error(`خطا در تولید تصویر نمودار ${id}`);
                };

                const generateChartsForData = async (data, prefix) => {
                    const sorted = [...data].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                    const folder = chartsFolder.folder(prefix);
                    
                    const commonOptions = {
                        chart: { 
                            type: 'line', height: 600, width: 1000, 
                            animations: { enabled: false }, background: '#fff', toolbar: { show: false }
                        },
                        xaxis: { 
                            categories: sorted.map(d => d.date || d.time || ''),
                            labels: { rotate: -45, style: { fontSize: '12px' } }
                        },
                        yaxis: { labels: { formatter: (val) => val ? val.toLocaleString() : val } },
                        title: { align: 'center', style: { fontSize: '22px', fontWeight: 'bold' } },
                        stroke: { width: 3, curve: 'smooth' }
                    };

                    // Candlestick
                    if (sorted[0].open && sorted[0].close) {
                        const candleData = sorted.map(d => ({
                            x: d.date || d.time,
                            y: [d.open, d.high, d.low, d.close]
                        }));
                        const options = {
                            ...commonOptions,
                            chart: { ...commonOptions.chart, type: 'candlestick' },
                            title: { ...commonOptions.title, text: `${symbol} (${prefix})` },
                            series: [{ data: candleData }]
                        };
                        const img = await captureChart(options, 'chart_export_tmp');
                        folder.file(`${symbol}_Candlestick.png`, img, { base64: true });
                    }

                    // Indicators
                    const baseKeys = ['date', 'time', 'open', 'high', 'low', 'close', 'volume', 'l18', 'l30', 'isin', 'cs', 'cs_id', 'eps', 'pe', 'pc', 'pcc', 'pcp', 'pmin', 'pmax', 'count', 'Signal', 'Pattern'];
                    const indicatorKeys = Object.keys(sorted[0]).filter(k => !baseKeys.includes(k) && typeof sorted[0][k] === 'number');
                    
                    for (const key of indicatorKeys) {
                        const options = {
                            ...commonOptions,
                            title: { ...commonOptions.title, text: `${key} (${prefix})` },
                            series: [{ name: key, data: sorted.map(d => d[key]) }]
                        };
                        const img = await captureChart(options, 'chart_export_tmp');
                        folder.file(`${key}.png`, img, { base64: true });
                    }
                };

                await generateChartsForData(currentData, "Daily");
                if (currentWeeklyData && currentWeeklyData.length > 0) {
                    await generateChartsForData(currentWeeklyData, "Weekly");
                }

                // 5. Finalize ZIP
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `Analysis_${symbol}_${today}.zip`);

            } catch (e) {
                console.error(e);
                alert('خطا در تولید پکیج: ' + e.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });
    </script>
    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">آمار دقیق درخواست‌ها به تفکیک سرویس</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>سرویس</th>
                                    <th>کل درخواست‌ها</th>
                                    <th>موفق</th>
                                    <th>مسدود شده</th>
                                    <th>نرخ موفقیت</th>
                                </tr>
                            </thead>
                            <tbody id="stats_table_body">
                                <!-- Stats will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info small">
                        <i class="fa-solid fa-info-circle me-1"></i>
                        درخواست‌های مسدود شده به دلیل محدودیت‌های سرور (Throttling) هستند. سرویس تحلیل تکنیکال اولویت بالاتری دارد.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
